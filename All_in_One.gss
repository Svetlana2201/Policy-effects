

/*

ALL PROCEDURES BELOW CAN BE USED AT YOUR OWN RISK AND RESPONSIBILITY

All other procedures were made by Svetlana Makarova and Wojtek Charemza. 

*/

declare matrix _y;
external matrix _y;

/* *********** ARMA-GARCH and DAR ESTIMATION PROCEDURES ********************************/

proc (7) =arma_k_garch1_estimation_NonZer(x1,x_ini,p0,b,pr);
	/*
	It allows for non-zero initial value for AR(k) 
	
	This procedure estimates the parameters of AR(k)-GARCH(1,1)
	model by Francq-Zakoian 'averaged' maximum likelihood method
    it requires CO_2.0 (constrained optimisation) Aptech Gauss package to be installed
    
    Inputs:
        x: n x 1 vector fo data
        x_ini: initial values of x, for the first lags:
                if x_ini=0; initial values of x for lags are zeros,
	            if x_ini=-999; initial values of x for lags are x1[1:k], 
                otherwise x_ini should be a k x 1 vector
	
        p0: k+3 x 1 vector of initial values of parameters:
                p0[1]: constant for AR
                p0[2],...,p0[k+1]: initial values of the AR(k) parameters,
                        from lag 1 to lag k
                p0[k+2] constant in GARCH
                p0[k+3] coefficient on the AR element in GARCH (that is, on h(t-1))
                p0[k+4] coefficient on the MA element in GARCH (that is, on sigma^2(t-1))
    
        b: if 0: only asymptotic standard errors are computed from the inverted Hessian
           if 1: bootstrapped standard errors are also computed (number of bootstraps is later controlled by n_boot)
       pr: if 1: basic estimation results are printed
    
    Outputs:
  (1)     p:    vector k+4 x 1 of the estimated parameters
  (2)     s:    if b=0: vector k+4 x 1 of the asymptotic standard errors 
                if b=1: matrix k+4 x 2 of the asymptotic standard errors (column 1) 
                                  and bootstrapped standard errors (column 2)
  (3)    fmin:   final value of the likelihood function
  (4)     res:   unscaled residuals (that is gross of GARCH), n x 1 vector   
  (5)    resh:   scaled (by GARCH) residuals, n x 1 vector
  (6)      cv:   conditional variance (n x 1 vector)
  (7) retcode:   error code (hopefully 0)

	*/
	local k, p, fmin,g,retcode, res,cv,t, nobs, resh,cc,cl,i,hes,s;
    local p_boot,s_boot,u_boot,ind,e,res_boot,x_boot,p_b,st_boot;
    local retcode_b,n_boot,cv_boot,g_b,y0;
	local x;
	
	_y=x1; 
	x=x1;
     
    k=rows(p0)-4;
    if x_ini==0;
       x_ini=zeros(k,1);
	elseif x_ini==-999;
		x_ini=x[1:k];
		x=x[k+1:rows(x)];
    endif;
    if rows(x_ini) ne k;
        ?;
        ? "*****************************************************************************************";
        print "ERROR in arma_k_garch1_estimation: vector of initial values of data has wrong dimension";
        stop;
    endif;
        
    cl={0.01,0.99};   
    cl=cl'.*ones(rows(p0),2);
    cl[2:k+1,.]=(-0.99~0.99).*ones(k,1);
    cl[1,.]=-100~100;
    cl[k+2,.]=0.01~100;
	cc=(p0-1.*abs(p0))~(p0+1.*abs(p0));      //constant here controls the width of the interval. Usually it should be =1
    cc=(maxc(cc[.,1]'|cl[.,1]')~minc(cc[.,2]'|cl[.,2]'));
 
    _co_Bounds=cc;
	
	_y=x_ini|x; 

	{ p,fmin,g,retcode } = co(&qfct_k_NZ,p0);
	
    nobs=rows(x);	
     hes=_co_FinalHess; 
    s=diag(abs(inv(-hes)./nobs));  
	res=zeros(nobs+k,1);
    resh=zeros(nobs+k,1);
	cv=ones(nobs+k,1);
    x=x_ini|x;
	for t (1,nobs,1);
        res[t+k]=x[t+k]-p[1]-(p[2:k+1])'rev(x[t:t+k-1]);
		cv[t+k]=p[k+2]+p[k+3]*cv[t+k-1]+p[k+4]*res[t+k-1].*res[t+k-1];  
	endfor;
    res=res[k+1:rows(res)];
    cv=cv[k+1:rows(cv)];
	resh=res./sqrt(cv);  	
	
    if b==1;
        n_boot=100;
        p_boot=zeros(n_boot,rows(p0));
        s_boot=ceil(rndu(1,1).*1000);
    
        for i (1,n_boot,1);		
			y0=x[k+1:rows(x)]; 
            {u_boot,s_boot}=rndKMu(rows(res),1,s_boot); 
            ind=ceil(nobs.*u_boot);
            e=ind .eq 0;
            ind=substute(ind,e,1);
			res_boot=zeros(k,1)|res[ind]; 
            x_boot=zeros(nobs+k,1);
			x_boot[1:k]=x_ini; 
            cv_boot=ones(nobs+k,1);
            for t (1,nobs,1);  
                cv_boot[t+k]=p[k+2]+p[k+3]*cv_boot[t+k-1]+p[k+4]*res_boot[t+k-1].*res_boot[t+k-1];    
				x_boot[t+k]= p[1]+(p[2:k+1])'rev(x_boot[t:t+k-1])+res_boot[t+k];   
            endfor; 
             _y=x_boot;
            {p_b,fmin,g_b,retcode_b}=co(&qfct_k_NZ,p0);           
            p_boot[i,.]=p_b'; 
           _y=x1; 
        endfor; 
        st_boot=stdc(p_boot);
        s=s~st_boot;
    endif;   
    if pr==1;
        format /rd 12,4;
        if b==0;
            ?;
            print "    Parameter         Initial   coefficients  gradients    st.errors";
            ?;
        elseif b==1;  
            print "    Parameter         Initial   coefficients  gradients    st.errors   boot.st.errors";
        endif;
        for i(1,rows(p),1);
            if i==1;
                print $"    Const AR:   ";;
            elseif i gt 1 and i le k+1;
                print $"      AR("$+ftocv(i-1,1,0)$+"):    ";;
            elseif i==k+2;
                print $"    Const GARCH:";;
            elseif i==k+3;
                print $"    GARCH AR(1):";;
            elseif i==k+4;
                print $"    GARCH MA(1):";;
            endif;
            print p0[i];;
            print p[i];;
            print g[i];;
            print s[i,.];
        endfor;
    endif; 	
	retp (p,s,fmin,res,resh,cv,retcode);
endp;

proc  qfct_k_NZ(b);  //This is the procedure which formulates the AR(k) likelihood function 
	local y1,k,q,t,e,h,lik;
    
    k=rows(b)-4;
	e=zeros(rows(_y),1); 
	h=ones(rows(_y),1);  
    y1=_y;      
    
	for t (1,rows(_y)-k,1); 
		e[t+k]=y1[t+k]-b[1]-b[2:k+1]'rev(y1[t:t+k-1]);
		h[t+k]=b[k+2]+b[k+3]*h[t+k-1]+b[k+4]*e[t+k-1]*e[t+k-1];      
	endfor;
    e=e[k+1:rows(e)];
    h=h[k+1:rows(h)];  
	lik=-0.5*((e./sqrt(h)).^2 +ln(h));  
	q=meanc(lik);			            
	retp(-q);
endp;

proc (1) = ini_vals(y,k);
    local n,x,i,b;  
   n=rows(y); 
    x={};
    for i (1,k,1);
        x=x~(zeros(i,1)|packr(lagn(y,i)));
    endfor;
   
    x=ones(n,1)~x;
    b=invpd(x'x)*x'y;  /* b1-const, b2 - coeff on x(-1) etc */
    	
	@ stationarity condition, uncomment if needed @
    /*
    c=rev(b[2:k+1])|(-1);    // All roots of b_k*Z^k+b_(k-1)*Z*(k-1)+...+b_1*Z-1=0 must be outside the unit circle  
    r=polyroot(c); 
    if minc(abs(r)) le 1;
        ?;
        print "WARNING: Initial values give non-stationary process";
        ?;
    endif;	
	*/
    retp(b);
endp;

proc (1) = opt_k_S_NZ(y,switch_ini, km,s, garch_param);
  local k,a_p0,g_p0,pg,sg,eg,ehg,hg,retcodeg,liklg;  
    local c_autg,p_autg,k_final;
	Local p0; // added
  k=km; 
   do until k < 1;
       a_p0=ini_vals(y,k);
	   g_p0=garch_param; 
       p0=a_p0|g_p0; 
       {pg,sg,liklg,eg,ehg,hg,retcodeg}=arma_k_garch1_estimation_NonZer(y,switch_ini,p0,0,0); 	   
       if s==0;
            {c_autg,p_autg}=Ljung_Box(eg,12);
       elseif s==1;
            {c_autg,p_autg}=Ljung_Box_Het(eg,12);
       endif;   
       	   if (p_autg gt 0.1);// or (pg[k+1]/sg[k+1] lt 2);     //Criterion: either no autocorrelation
            if k==1;                                     //or the deepest autoregressive coefficient is not significant
                k_final=k;
                goto lab;
           endif;
       else;
            if k==km; 
                print "*************** WARNING *******************";
				print "For k_max  =";;$ftocv(km,1,0);;" there is still autocorrelation in residuals";   
                print "Ljung_Box statistic: ";; c_autg; 
                print " Consider increasing k_max";
                k_final=km; 
                goto lab;
            elseif k lt km; 
                ?;
                k_final=k+1;
                goto lab;
            endif;
        endif;
        k=k-1;     
   endo; 
   lab:  
   retp(k_final);
endp;

/* *********** SIMULATION PROCEDURES ********************************/
proc (1) = rndKM_DAR_k_wsn(p,w,n,s);
        /*
        The procedure simulates DAR(no constant,k,1) model with WSN residuals
        Inputs:
        //p: 2 x 1 vector of DAR parameters (alpha0, omega0, gamma0)
		p: (k+2) x 1 vector of DAR parameters (kx1 vector of alphas), omega0, gamma0
        w: 5 x 1 vector of standardized WSN parameters (alpha, beta, m, k, rho). Standardized means that sigma=1
        n: output vector length
        s: state for random number generator
    
    
        */
        local x,e,t,u,k;
        
        k=rows(p)-2;
        e=zeros(n+k,1);
        x=zeros(n+k,1);
        u=rndKM_wsn(w[1],w[2],w[3],w[4],w[5],n+k,s);
        for t (k+1,n+k,1);
             // e[t]=u[t]*sqrt(p[2]+p[3]*x[t-1]);   //
			e[t]=u[t]*sqrt(p[k+1]+p[k+2]*(x[t-1]^2));
         //   x[t]=p[1]*x[t-1]+e[t];
            x[t]=p[1:k]'rev(x[t-k:t-1])+e[t];
        endfor;
		retp (x[k+1:n+k]);
    endp;
    
proc (1) = rndKM_DAR_k_wsn(p,w,n,s);
        /*
        The procedure simulates DAR(no constant,k,1) model with WSN residuals
        Inputs:
        //p: 2 x 1 vector of DAR parameters (alpha0, omega0, gamma0)
		p: (k+2) x 1 vector of DAR parameters (kx1 vector of alphas), omega0, gamma0
        w: 5 x 1 vector of standardized WSN parameters (alpha, beta, m, k, rho). Standardized means that sigma=1
        n: output vector length
        s: state for random number generator
    
        */
        local x,e,t,u,k;
        
        k=rows(p)-2;
        e=zeros(n+k,1);
        x=zeros(n+k,1);
        u=rndKM_wsn(w[1],w[2],w[3],w[4],w[5],n+k,s);
        for t (k+1,n+k,1);
			e[t]=u[t]*sqrt(p[k+1]+p[k+2]*(x[t-1]^2));
            x[t]=p[1:k]'rev(x[t-k:t-1])+e[t];
        endfor;
		retp (x[k+1:n+k]);
    endp;
        
     proc (1) = rndKM_wsn(a,b,m,k,r,n,state);
        local x,z,covar,ch,s1;
        /*
        This procedure generates the 'standardized'
        5-parameters weighted skew-normal distribution
        with asymmetric barriers, zero means and unitary variances
         
        Mean is not necessarily zero; Mean=a*phi(m)-b*phi(k); phi - pdf of N(0,1)
         
        */ 
        {x,s1}=rndKMn(n,2,state); 
        covar=(1~r)|(r~1);
        ch=chol(covar);
        x=(ch'*x')';
        z=x[.,1]+a*x[.,2].*(x[.,2].gt m)+b*x[.,2].*(x[.,2] .le k);
        retp (z);
    endp;
    
proc (1) = rnd_ar_k_ga_wsn(a,b,w,n);
	/*
	The procedure simulates ARMA(k,0)-GARCH(1,1) model with WSN residuals
	Inputs:
		a: (k+1) x 1 vector of AR parameters (first constant, next AR(k) parameters
		b: 3 x 1 vector of GARCH parameters (constant, parameter on GARCH, parameter on ARCH
		w: 5 x 1 vector of standardized WSN parameters (alpha, beta, m, k, rho). Standardized means that sigma=1 
		n: output vector length
    
	*/
	local k,x,e,s2,t,u;
    k=rows(a)-1;
	x=zeros(n+k,1);
	e=zeros(n+k,1);
	s2=ones(n+k,1);
	u=rnd_wsn(w[1],w[2],w[3],w[4],w[5],n+k); 
	for t (k+1,n+k,1);		
		s2[t]=b[1]+b[2]*s2[t-1]+b[3]*e[t-1]^2;	
        e[t]=sqrt(s2[t])*u[t];	
        x[t]=a[1]+a[2:k+1]'rev(x[t-k:t-1])+e[t];
	endfor;
	x=x[k+1:n+k]; 
	retp (x);
endp;

proc (1) = rnd_wsn(a,b,m,k,r,n);
	local x,z,covar,ch,s;
	/*
	This procedure generates the 'standardized'
	5-parameters weighted skew-normal distribution 
	with asymmetric barriers, zero means and unitary variances
    
	*/
	s=ceil(rndu(1,1).*1000);
	{x,s}=rndKMn(n,2,s);
	covar=(1~r)|(r~1);
	ch=chol(covar);
	x=(ch'*x')';
	z=x[.,1]+a*x[.,2].*(x[.,2].gt m)+b*x[.,2].*(x[.,2] .le k);
	retp (z);
endp;


/* *********** LM TESTING AND PVALS PROCEDURES ********************************/

proc (1) = LM_shuffled_dar(x,res,cv,s,ar_ord);
	/*
	This procedure computes LM,n,statistic, as in (Q2) using DAR
	arguments:
		x:      data
		res:    residuals
		cv:     conditional variance
		s:      matrix 3 x no of shuffles: 1st row: m; 2nd row: k, 3rd row: rho
        ar_ord: order of AR part in DAR
    output: 
        no.of shuffles x 1 vector of LM's
	*/
	local n, i, pz, v; 
    n=cols(s);
	v=zeros(n,1);
	for i (1,n,1);
       pz=s[.,i];
	   v[i]=LM_fixed_dark(x,res,cv,pz,ar_ord);
	endfor;
	retp(v);
endp;

proc(1) = itu(f1,f2,f3,x);
	/*
	This procedure computes I_theta_u, see Section 4
	*/
	local I_11, I_22, I_12, I_u;  
	local f1: proc;
	local f2: proc;
	local f3: proc;
	struct DS *pds;
	struct DS d0;
	struct inthpControl c0;

	c0 = inthpControlCreate;
	c0.eps = 1e-5;
	pds = &d0;
	d0.dataMatrix=x;
	
	I_11=inthp1(&f1,pds,c0);									
	I_22=inthp1(&f2,pds,c0); 
	I_12=inthp1(&f3,pds,c0);
	
	I_u=(I_11~I_12)|(I_12~I_22);
	retp (I_u);
endp;


proc (1) = fg2_ap(struct DS *pds,x);   //Procedure for computing W1 ([1,1] element, see Section 4)
	local p,r,m,m1,g_ap1,g_ap;
	p = pds->dataMatrix;
	r=sqrt(1-p[3]^2);
	m=(p[3]*x-p[1])/r;
	m1=((r^2)*x-p[1]*p[3])/r;
	g_ap1=((x^2)-1).*p[3].*cdfN(m)+pdfN(m).*m1; 
	g_ap=(1/sqrt(2*pi))*(g_ap1^2)*exp(-(x^2)/2); 
retp (g_ap);
endp;

proc (1) = fg2_bp(struct DS *pds,x); //Procedure for computing W2 ([2,2]see Section 4)
	local p,r,m,m1,g_bp1,g_bp;
	p = pds->dataMatrix;
	r=sqrt(1-p[3]^2);
	m=(p[3]*x-p[2])/r;
	m1=(p[2]*p[3]-(r^2)*x)/r;
	g_bp1=((x^2)-1).*p[3].*cdfN(-m)+pdfN(m).*m1; 
	g_bp=(1/sqrt(2*pi))*(g_bp1^2)*exp(-(x^2)/2); 
retp (g_bp);
endp;

proc (1) = fg_abp(struct DS *pds,x); //Procedure for computing [2,1] element in W11, see Section 4
	local p,r,ma,m1a, mb,m1b,g_ap1,g_bp1,g_abp;

	p = pds->dataMatrix;
	r=sqrt(1-p[3]^2);
	ma=(p[3]*x-p[1])/r;
	m1a=((r^2)*x-p[1]*p[3])/r;
	g_ap1=((x^2)-1).*p[3].*cdfN(ma)+pdfN(ma).*m1a; 
	
	mb=(p[3]*x-p[2])/r;
	m1b=(p[2]*p[3]-(r^2)*x)/r;
	g_bp1=((x^2)-1).*p[3].*cdfN(-mb)+pdfN(mb).*m1b; 
	g_abp=(1/sqrt(2*pi))*g_ap1*g_bp1*exp(-(x^2)/2); 
		
retp (g_abp);
endp;

proc (2) =D_ms_test_ar(x,res,cv,p);
	/*
	This procedure computes D_hat,m,t and D_hat_sigma_t for the AR(p)-GARCH(1,1) case.
	
	output:
	- dm:		(p+1) x nobs matrix.
	- ds: 		3 x nobs matrix.
	
	*/
	local x1,cv1,res1,a_1,a_2,dm,ds,i;  
	x1=0|packr(lag1(x));    
	if p>1;
		for i (2,p,1);
			x1 = x1~(zeros(i,1)|packr(lagn(x,i)));
		endfor;
	endif;
	cv1=1|packr(lag1(cv));			
	res1=0|packr(lag1(res));	
	a_1=ones(rows(x1),1)~x1;
	a_2=ones(rows(res1),1)~(res1.^2)~cv1; 
	dm=(1/sqrt(cv)).*a_1;  dm=dm';
	ds=(1/(2*cv)).*a_2;  ds=ds';
	retp(dm,ds);
endp;

proc (2) = I_pm_test_ar(x,res,cv,p,ar_ord);
	/*
	Matrix I_hat_n for the AR(p)-GARCH(1,1) case
	*/
	
	local D_m,D_s,I_m,I_s,f_p, I_theta_u; 
	local I_m_theta_u, I_theta_u_m;
	local I_s_theta_u, I_theta_u_s, I_theta;
	local I_theta_u_theta, Id_2, M_p1;
	local I_p_matrix, M_p_matrix;
	I_theta_u=itu(&fg2_ap,&fg2_bp,&fg_abp,p);	
	{D_m,D_s}=D_ms_test_ar(x,res,cv,ar_ord); 
	I_m=ave_prod(D_m);						// (p+1)x(p+1)
	I_s=2*ave_prod(D_s);						// 3x3
	f_p=pdfN(p[1])|-pdfN(p[2]);					// 2x1
	I_m_theta_u=meanc(D_m')*f_p';	            		// (p+1)x2
	I_theta_u_m=I_m_theta_u';					// 2x(p+1)
	I_s_theta_u=meanc(D_s')*f_p';             		// 3x2
	I_theta_u_s=I_s_theta_u';					// 2x3
	I_theta=(I_m~zeros(ar_ord+1,3))|(zeros(3,ar_ord+1)~I_s);
	I_theta_u_theta=I_theta_u_m~I_theta_u_s;
	I_p_matrix=(I_m~zeros(ar_ord+1,3)~I_m_theta_u)|(zeros(3,ar_ord+1)~I_s~I_s_theta_u)|(I_theta_u_m~I_theta_u_s~I_theta_u);   //W12
	Id_2=eye(2);   							// corrected
	M_p1=I_theta_u-I_theta_u_theta*inv(I_theta)*I_theta_u_theta';
	M_p_matrix=inv(smsr_new(M_p1))*((I_theta_u_theta*inv(I_theta))~Id_2);   
	retp (I_p_matrix,M_p_matrix);
endp;

proc (1) = g_p(x, p);
/* 
	This procedure computes g_alpha,pi(x) and g_beta,pi(x), that is W1 and W2 in sECTION 4
	and returns it as the nobs x 2 matrix inputs:
	x: the argument 
	p: vector of m,k and rho
*/
	local r,a_m, a_k, a_m1, a_m2, g_a, g_b;
   // print p';
	r=sqrt(1-p[3]^2);
	a_m=(p[3]*x-p[1])/r;
	a_k=(-p[3]*x+p[2])/r;
	a_m1=((r^2)*x-p[1]*p[3])/r;
	a_m2=(p[2]*p[3]-(r^2)*x)/r;
	g_a=((x^2)-1).*p[3].*cdfN(a_m)+pdfN(a_m).*a_m1;     // W1
	g_b=((x^2)-1).*p[3].*cdfN(a_k)+pdfN(-a_k).*a_m2;    //W2
	retp (g_a~g_b);
endp;

proc (1) = drv_Q(x,p);
	/*
	This procedure computes the first derivative of Qn, as in (W5)
	input: w: vector of data
		   p: m,k and rho
	*/
	local g,n,q;
	g=g_p(x,p);
	n=rows(x);
	q=(1/n)*(sumc(g[.,1])|sumc(g[.,2]));
	retp (q);
endp;

proc (1) = LM_fixed_ar(x,res,cv,p,ar_ord);
	/*
	This procedure computes LM,n,pi statistic for the AR(p)-GARCH(1,1) case
	arguments:
		x:   data
		res: ARMA-GARCH residuals
		cv:  conditional variance
		p:   m, k and rho
		ar_ord: autoregressive order.
	*/
	local I_p,I_m, dqn, LM_1, Iup_theta_u, LM_n_pstat; 	
	{I_p,I_m}=I_pm_test_ar(x,res,cv,p,ar_ord);
	dqn=drv_q(res./sqrt(cv),p);	
	LM_1=inv(I_p);
	Iup_theta_u=LM_1[rows(LM_1)-1:rows(LM_1),rows(LM_1)-1:rows(LM_1)];
	LM_n_pstat=rows(x)*dqn'*Iup_theta_u*dqn;  // W14 not multiplied by n
	retp(LM_n_pstat);
endp;

proc (1) = LM_shuffled_ar(x,res,cv,s,ar_ord);
	/*
	This procedure computes LM,n,statistic, as in (Q2)
	 
	arguments:
		x:   data
		res: ARMA-GARCH residuals
		cv:  conditional variance
		s:   matrix 3 x no of shuffles: 1st row: m; 2nd row: k, 3rd row: rho 
    output: 
        no.of shuffles x 1 vector of LM's
	*/
	local n, i, pz, v;
    n=cols(s);
	v=zeros(n,1);
	for i (1,n,1);
        pz=s[.,i]; 
		v[i]=LM_fixed_ar(x,res,cv,pz,ar_ord);
	endfor;
	retp(v);
endp;

proc (1)=pvals(stat,n,j,sym,k,s,bezier);
    /* The procedure computes p_values approximated
       by spline of an empirical statistic.
       Inputs:
             stat: statistic to be tested
                n:  sample size
                j: index of input file: j=0 means switch_sup=0;
                                        j=1 means switch_sup=1
              sym: sym=0 means that switch_symMK=0, sym=1 means that switch_symMK=1
                k: index of input file: if k=1,2,..,12, it means order of AR in AR(k)-GARCH(1,1)
                                        if k=0, it means ARMA(1,1)-GARCH(1,1)
                s: if 0: p-values are computed for the point quantile estimate
                   if 1: statistics are computed for the point quantile estimate and for 
                         lower and upper limits of the 2 standard deviations interval
                b: if 0: there is no smoothing for given n across quantiles 
                   if 1: there is a Bezier smoothing across quantiles
                         BETTER TO KEEP IT AT ZERO: IF b=1, IT TAKES A LOT OF TIME !!!!
      Outputs:
             pvals:
                if s=0: scalar, p-value of the point quantile estimate
                if s=1: 3 x 1 vector of p-values:
                        (1) for the point estimate
                        (2) for the lowe limit
                        (3) for the upper limit
       
       General remarks: (1) It needs file data prepared by Francq_seven_assembler_size
                            to be in the working directory
                        (2) It accesses the following procedures:                           
                            find_val
                            find_row (in find_val)   
                            bezier2 (if b=1)
                        (3) file prepared by Francq_seven_assembler_size
                            contains a matrix with the first row of 0~observations for which quantiles are available
                                                       first column of probabilities corresponding to the computed quantiles
                                                       matrix of quantiles, where each row corresponds to different sample size 
    */
    local name_q, x_in,s_in,qr,nobs_v,q_vals;
    local u_q,v_nobs,w, i_appx;
    local k_appx,i,wx,pval,pvall,pvalh;
    local s_vals,s_sel,u_s,w_s,stat_hig,stat_low;

    name_q="C:\\Gprogs_21\\FZ_2022\\FZ_empirical_2016\\Quantiles_"$+ftocv(j,1,0)$+"_"$+ftocv(sym,1,0)$+"_"$+ftocv(k,1,0);
    load x_in=^name_q; 
    qr=x_in[1,.]';
    qr=qr[2:rows(qr)];
    nobs_v=x_in[.,1];
    nobs_v=nobs_v[2:rows(nobs_v)];
    q_vals=x_in[2:rows(x_in),2:cols(x_in)];
 
    {u_q,v_nobs,w}=spline(qr,nobs_v,q_vals',0,5);   //spline constants are set at tension factor=0; grid factor=5
    if bezier==1;
        for i (1,rows(w),1);
            wx=bezier2(v_nobs~w[i,.]',100); 
            w[i,.]=wx[.,2]';
        endfor;
    endif;
    {pval,k_appx,i_appx}=find_pval(stat,n,v_nobs,u_q,w);
    
    if s==1;
        name_q="Quanti_SE_"$+ftocv(j,1,0)$+"_"$+ftocv(sym,1,0)$+"_"$+ftocv(k,1,0);
        load s_in=^name_q; 
        s_vals=s_in[2:rows(s_in),2:cols(s_in)];  
        {u_s,v_nobs,w_s}=spline(qr,nobs_v,s_vals',0,5);   //spline constants are set at tension factor=0; grid factor=5
        s_sel=w_s[k_appx,i_appx];
        stat_low=stat-2*s_sel;
        stat_hig=stat+2*s_sel;
        {pvall,k_appx,i_appx}=find_pval(stat_low,n,v_nobs,u_q,w);
        {pvalh,k_appx,i_appx}=find_pval(stat_hig,n,v_nobs,u_q,w);
        pval=pval|pvall|pvalh;       
    endif;
    retp((pval));   
endp;

 proc (3)=find_pval(s,m,vn,uq,v);
     /*
     The procedure finds p-value vy 
     (1) finding our which number of observations in the vector,
         for which p-values are available is the closest to the empirical
         number of observations (i)
     (2) for this approximated number of observations it finds the approximated
         quantile, which is the closest to the empirical test statistic (j)
     (3) identifies p-value for the pair of i,j
     Inputs:
        s:  value of the statistic (either empirical, or low/high)
        m:  number of observations
        vn: vector of observations to be searched
        uq: vector of probabilities to be searched
        v:  matrix of quantiles with number of columns equal to the number of rows of vn
                                and number of rows equal to the number of rows in uq 
     */
     local na,ia,sa,ka;
     {na,ia}=find_row(m,vn);
    {sa,ka}=find_row(s,v[.,ia]);
    if s .gt (v[rows(v),ia]*1.001);
        uq[ka]=1;
    endif;
    if s .lt (v[1,ia]*1.001);
        uq[ka]=0;
    endif;
    retp((1-uq[ka]),ka,ia);
endp;

proc (2) = find_row(n,v);
  local n_a, r_n, i;
        
    if n le v[1];
        n_a=v[1];
        r_n=1;
    elseif n ge v[rows(v)];
        n_a=v[rows(v)];
        r_n=rows(v);
    else;
        for i (1, rows(v)-1,1);
            if n gt v[i] and n lt v[i+1];
                if abs(n-v[i]) lt abs(n-v[i+1]);
                    n_a=v[i];
                    r_n=i;
                else;
                    n_a=v[i+1];
                    r_n=i+1;
                endif;
            endif;
        endfor;
    endif;
    retp(n_a,r_n);
 endp;
 
 proc (1) = LM_fixed_dark(x,res,cv,p,ar_ord); 
	/*
	This procedure computes LM,n,pi statistic for the AR(p)-GARCH(1,1) case
	arguments:
		x:   data
		res: DAR(k,1) residuals, res=resid=X(t)-beta*X(t-1); it's not an innovation!
		cv:  conditional variance
		p:   m, k and rho
		ar_ord: autoregressive order.
	*/
	local I_p,I_m, dqn, LM_1, Iup_theta_u, LM_n_pstat; 	
	{I_p,I_m}=I_pm_test_dar(x,cv,p,ar_ord);
    dqn=drv_q(res./sqrt(cv),p);	
	LM_1=inv(I_p);
	Iup_theta_u=LM_1[rows(LM_1)-1:rows(LM_1),rows(LM_1)-1:rows(LM_1)];  // This mnatrix must be positively defined 
        
    if minc(eigh(I_p)) .le 0; print minc(eigh(I_p)); "I_p is not positively defined"; stop;endif;  
	if minc(eigh(Iup_theta_u)) .le 0; print minc(eigh(Iup_theta_u)); "Iup_theta_u is not positively defined"; stop; endif;      
        
    LM_n_pstat=rows(x)*dqn'*Iup_theta_u*dqn;
    	   
	retp(LM_n_pstat);
endp;

      
proc (1) = I_pm_DAR(x,cv,p); 
    /* OBSOLETE*/    
    local I_theta_minus_u, f_p, lambda_p;
    local D_m,D_s,I_m,I_s;
    local I_m_theta_minus_u, I_theta_minus_u_m; 
    local I_s_theta_minus_u, I_theta_minus_u_s;
    local I_theta, I_theta_minus_u_theta;
    local I_p_matrix;
        
        I_theta_minus_u=itu_g(&int_ap,&int_bp,&int_abp,p);     @ (W11) in WSN8 DAR @
        f_p=pdfN(p[1])|-pdfN(p[2]);                                        @ (4) in WSN8 DAR   @
          lambda_p=lambda_g(&int_lambda1,&int_lambda2, p);       
        {D_m,D_s}=D_ms(x,cv); 
        I_m=ave_prod(D_m);							// W6-DAR1
        I_s=2*ave_prod(D_s); 	   		            //W7-DAR1
		
        I_m_theta_minus_u=meanc(D_m')*f_p';	     //W9
        I_theta_minus_u_m=I_m_theta_minus_u';
        I_s_theta_minus_u=meanc(D_s')*lambda_p';     //W10-NEW
        I_theta_minus_u_s=I_s_theta_minus_u';
        I_theta=(I_m~zeros(1,2))|(zeros(2,1)~I_s);
        I_theta_minus_u_theta=I_theta_minus_u_m~I_theta_minus_u_s;
        I_p_matrix=(I_theta~I_theta_minus_u_theta')|(I_theta_minus_u_theta~I_theta_minus_u);   
       
       retp (I_p_matrix);
    endp;
    
proc (2) = I_pm_test_dar(x,cv,p,ar_ord);   // p = (m, k, rho) 
	/* Last modification: 16/01/2022. This one is used for LM_test_dark*/
	
	local D_m,D_s,I_m,I_s,f_p, I_theta_u; 
	local I_m_theta_u, I_theta_u_m;
	local I_s_theta_u, I_theta_u_s, I_theta;
	local I_theta_u_theta, Id_2, M_p1;
	local I_p_matrix, M_p_matrix, l_p, k;
        
    I_theta_u=itu_g(&int_ap,&int_bp,&int_abp,p);   //I_theta_minus_u formula (A.9) in WSN8   
    l_p=lambda_g(&int_lambda1,&int_lambda2,p);         
	{D_m,D_s}=D_ms_test_dar(x,cv,ar_ord);       // kxn , 2xn,       
    k=rows(D_m);
	I_m=ave_prod(D_m);				// kxk 
	I_s=2*ave_prod(D_s);				// 2x2
	f_p=pdfN(p[1])|-pdfN(p[2]);			// 2x1
    I_m_theta_u=meanc(D_m')*f_p';	            // kx2      I_m_theta_minus_u
	I_theta_u_m=I_m_theta_u';			// 2xk      I_m_theta_minus_u_m
    I_s_theta_u=meanc(D_s')*l_p';               // 2x2      I_s_theta_minus_u
    I_theta_u_s=I_s_theta_u';		            // 2x3      I_s_theta_minus_u_s
    I_theta=(I_m~zeros(k,2))|(zeros(2,k)~I_s);  // (k+2)x(k+2)
	I_theta_u_theta=I_theta_u_m~I_theta_u_s;    // 2x(k+2)
    I_p_matrix=(I_theta~I_theta_u_theta')|(I_theta_u_theta~I_theta_u);    
	Id_2=eye(2);   							
	M_p1=I_theta_u-I_theta_u_theta*inv(I_theta)*I_theta_u_theta';
	M_p_matrix=inv(smsr(M_p1))*((I_theta_u_theta*inv(I_theta))~Id_2);   
	retp (I_p_matrix,M_p_matrix);
endp;

proc (1) = int_ap(p,x);   //Procedure for computing [1,1] element in W11, Gautschi; p = (m, k, rho)
        local g_ap1,g_ap;
        g_ap1=g_p(x,p);    
        g_ap1=g_ap1[1];       
        g_ap=(1/sqrt(2*pi))*(g_ap1^2)*exp(-(x^2)/2);
        retp (g_ap);
    endp;
    
proc (1) = int_bp(p,x); //Procedure for computing 2,2] element in W11, 
        local g_bp1,g_bp;
    
        g_bp1=g_p(x,p);    //W-22
        g_bp1=g_bp1[2];        //W-22
        
        g_bp=(1/sqrt(2*pi))*(g_bp1^2)*exp(-(x^2)/2);
        retp (g_bp);
    endp;
    
proc (1) = int_abp(p,x); //Procedure for computing [2,1] element in W11, 
        local g_ap12, g_ap1,g_bp1,g_abp;
        
        g_ap12=g_p(x,p);    
        g_ap1=g_ap12[1];        
        g_bp1=g_ap12[2];        
        g_abp=(1/sqrt(2*pi))*g_ap1*g_bp1*exp(-(x^2)/2);
        
        retp (g_abp);
    endp;
    
proc (1) = int_lambda1(p,x);   //Procedure for computing first element in lambda,
        local r,m,m1,g_ap1,g_lam1;
        r=sqrt(1-p[3]^2);
        m=(p[3]*x-p[1])/r;
        m1=((r^2)*x-p[1]*p[3])/r;  
        g_ap1=((x^2)-1).*p[3].*cdfN(m)+pdfN(m).*m1;
		g_lam1=(1/sqrt(2*pi))*((x^2)-1)*(g_ap1)*exp(-(x^2)/2);   
        retp (g_lam1);
    endp;
    
proc (1) = int_lambda2(p,x); //Procedure for computing second element in lambda, 
        local r,m,m1,g_bp1,g_lam2;
        r=sqrt(1-p[3]^2);
        m=(p[3]*x-p[2])/r;
        m1=(p[2]*p[3]-(r^2)*x)/r;  
        g_bp1=((x^2)-1).*p[3].*cdfN(-m)+pdfN(m).*m1;
		g_lam2=(1/sqrt(2*pi))*((x^2)-1)*(g_bp1)*exp(-(x^2)/2); 
        retp (g_lam2);
    endp;
    

proc(1) = itu_g(&f1,&f2,&f3,x);
        local I_11,I_22,I_12,I_u;
        /*
        This procedure computes I_theta_u, in Section 4
        In order to use Lobatto, unblock the lines below and
        block the lines for Adapt_Simpson. The results are identical,
        but Lobatto is slower
        */
        if switch_int==1;
            I_11=Gauss_Lobatto(x,-10,10,f1);
            I_22=Gauss_Lobatto(x,-10,10,f2);
            I_12=Gauss_Lobatto(x,-10,10,f3);       
        elseif switch_int==0;
            I_11=Adapt_Simpson(x,-150,150,f1);
            I_22=Adapt_Simpson(x,-150,150,f2);
            I_12=Adapt_Simpson(x,-150,150,f3);
        endif;
        I_u=(I_11~I_12)|(I_12~I_22);
        retp (I_u);
    endp;
    
    proc(1)=lambda_g(&f1,&f2,x);
        local lambda1, lambda2, lambda_u;
        /*
        This procedure computes lambda, as given by (5) in 'WSN8 ARMA'
        */
        if switch_int==0;
            lambda1=Adapt_Simpson(x,-150,150,f1);
            lambda2=Adapt_Simpson(x,-150,150,f2);           
        elseif switch_int==1;
            lambda1=Gauss_Lobatto(x,-10,10,f1);
            lambda2=Gauss_Lobatto(x,-10,10,f2);
        endif;
         lambda_u=lambda1|lambda2;
        retp(lambda_u);
    endp;

proc (2) =D_ms(x,cv);
     /*
        This procedure computes D_hat,m,t and D_hat_sigma_t 
        output: two matrices 3 x nobs
     */
     local x1,a_1,a_2,dm,ds;
      x1=0|packr(lag1(x));
      a_1=x1;
      a_2=ones(rows(x1),1)~x1^2;
      dm=(1/sqrt(cv)).*a_1;
      dm=dm'; 			  // W3
      ds=(1/(2*cv)).*a_2;
      ds=ds';  			  // W4
      retp(dm,ds);
endp;

proc smsr(x);
        /*
        Computing square root of a matrix by diagonalization
        The square matrix must be diagonalised
        */
     local va, ve;
     local I_mat;
    
        {va,ve} = eighv(x);
        I_mat = eye(rows(va));
        I_mat = diagrv(I_mat, sqrt(va));
    
      retp(ve*I_mat*ve');
       
endp;     

proc (1)=lagn_matrix(x,p);
    local i,x1;
    x1=zeros(rows(x),p);   
    for i (1,p,1);
		x1[i+1:rows(x),i]=packr(lagn(x,i));
	endfor;
    retp(x1);
endp;
    

proc (2) =D_ms_test_dar(x,cv,p);  // cv=cond. variance; p = order of AR part 
	/*
	This procedure computes D_hat,m,t and D_hat_sigma_t for the DAR(p,1) case.
	Used for LM_dark
	output:
	- dm:		(p+1) x nobs matrix.
	- ds: 		3 x nobs matrix.
	
	*/
	local x1,a_1,a_2,dm,ds;
	x1=lagn_matrix(x,p);   
    a_1=x1;
    a_2=ones(rows(x1),1)~x1[.,1]^2;
	dm=(1/sqrt(cv)).*a_1;  dm=dm';
    ds=(1/(2*cv)).*a_2;  ds=ds';
	retp(dm,ds);
endp;

proc (1)= LM_pv_DAR (t,s,y,n,b);
    /*
      This is the first go at the procedure for 
      approximation of p-values on the LMn,p and LMn test for the DAR case.
      It approximates the distribution for the 
      actual ample size and then approximate p-values from the simulated cdf.
      Simple linear approximation is used here.
    
      In this version, the cdf has been approximated by the Monte Carlo simulation
      using program AR_3_GA_MC_1_5_A_test.gss, run on the University of Leicester HPC cluster Alice.
    
      The assembler used for creating the x_mat was AR_DAR_3_power_Assembler_1_test_1.gss, finished on
    
      inputs:
      t: the empiricald LMn,p or LMn statistic
      s: switch_sup in the main program, that is:
         if 0: LMn,p test is used
         if 1: LMn test is used with narrow shuffle limits around 1
         if 2: LMn test is used with wide shuffle limits around 1
               
      y: if 0: there is no symmetry of in shuffle in the LMn case
         if 1: there is symmetry of in shuffle in the LMn case
         IF s=0, y MUST BE 0 AS WELL.
      n: sample size
      b: dummy for Bezier smoothing of the quantiles (1 for smoothing, 0 for using raw simulated data)
         Unsmoothed p-values are less accurate, due to possible non-monotonocities, but are quicker to compute
         Note the constant in the Bezier procedure. The higher is it, the longer computation lasts.
         It seems that 100 is a good compromise
    */
   
    local x_mat,i,nv,c,w,x,q,p,v,g1;
    q=rev(seqa(1,1,99))./100;
    nv={200,400,600,1000,1600,3500};
    
    if s==0 and y ne 0;
        ? " *****************************************************************************";
        print "   Conflict with switches in procedure LM_pv_DAR. For LMn,p test (thast is, for switch_sup=0), switch_sum must be zero. Decide what you want to use ";
        stop;
    endif;
   
     x_mat=
    
  {
    0.02200      0.02159      0.01972      0.02010      0.02529      0.01760      0.02010      0.05655      0.05671      0.05055      0.05797      0.05685      0.04775      0.02010      0.04156      0.03814      0.03704      0.04108      0.04126      0.03519      0.02010       0.1172       0.1170      0.09911       0.1070       0.1092       0.1084      0.02010      0.08210      0.07803      0.06764      0.07745      0.07800      0.06154      0.02010 
     0.03973      0.04402      0.03910      0.04545      0.04854      0.03443      0.04041      0.08874      0.09201      0.08143      0.08865       0.1033      0.07676      0.04041      0.06628      0.06969      0.06223      0.06823      0.06993      0.05692      0.04041       0.1691       0.1783       0.1485       0.1579       0.1634       0.1501      0.04041       0.1203       0.1153       0.1059       0.1155       0.1215       0.1031      0.04041 
     0.05996      0.06650      0.05840      0.06826      0.06962      0.05179      0.06092       0.1171       0.1184       0.1127       0.1244       0.1298       0.1091      0.06092      0.09132      0.09344      0.08154      0.09231       0.1029      0.07784      0.06092       0.2136       0.2212       0.1894       0.1995       0.2044       0.1970      0.06092       0.1616       0.1525       0.1480       0.1540       0.1527       0.1312      0.06092 
     0.07824      0.08559      0.07702      0.09600      0.09367      0.07202      0.08164       0.1416       0.1478       0.1396       0.1581       0.1566       0.1348      0.08164       0.1153       0.1180       0.1052       0.1275       0.1271       0.1040      0.08164       0.2618       0.2609       0.2296       0.2385       0.2502       0.2475      0.08164       0.1882       0.1825       0.1806       0.1895       0.1790       0.1659      0.08164 
     0.09912       0.1077       0.1004       0.1158       0.1141      0.09648       0.1026       0.1784       0.1849       0.1702       0.1904       0.1837       0.1603       0.1026       0.1335       0.1450       0.1379       0.1507       0.1486       0.1282       0.1026       0.3036       0.3059       0.2753       0.2788       0.2806       0.2836       0.1026       0.2199       0.2111       0.2087       0.2191       0.2124       0.1951       0.1026 
      0.1194       0.1333       0.1274       0.1348       0.1373       0.1214       0.1238       0.2008       0.2116       0.2034       0.2142       0.2120       0.1928       0.1238       0.1679       0.1749       0.1658       0.1748       0.1749       0.1568       0.1238       0.3450       0.3506       0.3093       0.3084       0.3155       0.3174       0.1238       0.2459       0.2474       0.2452       0.2504       0.2497       0.2230       0.1238 
      0.1437       0.1569       0.1494       0.1592       0.1579       0.1449       0.1451       0.2273       0.2429       0.2319       0.2380       0.2387       0.2194       0.1451       0.1938       0.2016       0.1923       0.1995       0.2018       0.1799       0.1451       0.3844       0.3835       0.3470       0.3441       0.3554       0.3437       0.1451       0.2818       0.2836       0.2819       0.2724       0.2733       0.2554       0.1451 
      0.1660       0.1811       0.1696       0.1795       0.1836       0.1605       0.1668       0.2536       0.2702       0.2532       0.2632       0.2668       0.2449       0.1668       0.2160       0.2300       0.2173       0.2179       0.2200       0.2058       0.1668       0.4172       0.4169       0.3820       0.3801       0.3868       0.3782       0.1668       0.3117       0.3054       0.3107       0.3010       0.3067       0.2828       0.1668 
      0.1837       0.2056       0.1936       0.1971       0.2003       0.1799       0.1886       0.2806       0.2954       0.2842       0.2907       0.2920       0.2696       0.1886       0.2378       0.2559       0.2416       0.2434       0.2482       0.2295       0.1886       0.4485       0.4538       0.4191       0.4101       0.4232       0.4083       0.1886       0.3392       0.3369       0.3377       0.3277       0.3336       0.3061       0.1886 
      0.2077       0.2301       0.2174       0.2187       0.2247       0.2029       0.2107       0.3115       0.3252       0.3091       0.3180       0.3213       0.2910       0.2107       0.2634       0.2769       0.2689       0.2644       0.2716       0.2477       0.2107       0.4779       0.4868       0.4511       0.4457       0.4530       0.4516       0.2107       0.3722       0.3712       0.3729       0.3560       0.3641       0.3316       0.2107 
      0.2288       0.2563       0.2385       0.2431       0.2496       0.2271       0.2331       0.3373       0.3500       0.3425       0.3405       0.3518       0.3201       0.2331       0.2959       0.2982       0.2929       0.2866       0.3001       0.2713       0.2331       0.5173       0.5282       0.4815       0.4769       0.4867       0.4830       0.2331       0.4029       0.3953       0.4077       0.3758       0.3899       0.3554       0.2331 
      0.2508       0.2765       0.2590       0.2654       0.2744       0.2428       0.2557       0.3679       0.3723       0.3666       0.3681       0.3795       0.3402       0.2557       0.3149       0.3315       0.3156       0.3188       0.3241       0.2978       0.2557       0.5554       0.5573       0.5122       0.4987       0.5153       0.5094       0.2557       0.4272       0.4280       0.4340       0.4046       0.4147       0.3831       0.2557 
      0.2787       0.3015       0.2860       0.2934       0.2958       0.2696       0.2785       0.3964       0.4023       0.3969       0.3955       0.4109       0.3689       0.2785       0.3403       0.3568       0.3379       0.3426       0.3459       0.3170       0.2785       0.5878       0.5903       0.5402       0.5304       0.5452       0.5384       0.2785       0.4593       0.4566       0.4558       0.4386       0.4363       0.4131       0.2785 
      0.3013       0.3241       0.3099       0.3168       0.3219       0.2874       0.3016       0.4187       0.4285       0.4187       0.4236       0.4329       0.3980       0.3016       0.3663       0.3803       0.3630       0.3656       0.3731       0.3396       0.3016       0.6227       0.6258       0.5779       0.5644       0.5727       0.5738       0.3016       0.4882       0.4811       0.4841       0.4720       0.4682       0.4340       0.3016 
      0.3219       0.3472       0.3374       0.3437       0.3413       0.3157       0.3250       0.4418       0.4572       0.4507       0.4490       0.4543       0.4254       0.3250       0.3956       0.4048       0.3933       0.3995       0.3969       0.3686       0.3250       0.6596       0.6610       0.6112       0.6011       0.6134       0.6112       0.3250       0.5111       0.5028       0.5099       0.5011       0.4958       0.4615       0.3250 
      0.3496       0.3682       0.3616       0.3644       0.3620       0.3376       0.3487       0.4718       0.4876       0.4850       0.4764       0.4850       0.4453       0.3487       0.4159       0.4279       0.4193       0.4290       0.4241       0.3903       0.3487       0.6992       0.6919       0.6524       0.6371       0.6454       0.6448       0.3487       0.5444       0.5363       0.5380       0.5299       0.5303       0.4873       0.3487 
      0.3718       0.3861       0.3887       0.3886       0.3885       0.3615       0.3727       0.4955       0.5110       0.5183       0.5005       0.5127       0.4720       0.3727       0.4406       0.4538       0.4492       0.4518       0.4517       0.4159       0.3727       0.7322       0.7236       0.6924       0.6714       0.6789       0.6733       0.3727       0.5778       0.5694       0.5710       0.5643       0.5584       0.5080       0.3727 
      0.3899       0.4138       0.4113       0.4157       0.4163       0.3836       0.3969       0.5192       0.5360       0.5409       0.5348       0.5413       0.4957       0.3969       0.4645       0.4783       0.4799       0.4770       0.4768       0.4401       0.3969       0.7718       0.7570       0.7165       0.6997       0.7113       0.7041       0.3969       0.6104       0.5965       0.6053       0.5927       0.5875       0.5328       0.3969 
      0.4147       0.4359       0.4362       0.4417       0.4506       0.4116       0.4214       0.5474       0.5654       0.5624       0.5628       0.5743       0.5235       0.4214       0.4911       0.5022       0.5071       0.5028       0.5066       0.4679       0.4214       0.8046       0.7974       0.7446       0.7262       0.7477       0.7377       0.4214       0.6370       0.6360       0.6413       0.6239       0.6147       0.5621       0.4214 
      0.4399       0.4561       0.4660       0.4626       0.4713       0.4317       0.4463       0.5755       0.5943       0.5916       0.5937       0.5976       0.5515       0.4463       0.5205       0.5312       0.5313       0.5342       0.5335       0.4947       0.4463       0.8399       0.8337       0.7745       0.7513       0.7818       0.7713       0.4463       0.6636       0.6668       0.6733       0.6548       0.6430       0.5952       0.4463 
      0.4666       0.4807       0.4913       0.4856       0.4957       0.4591       0.4714       0.6093       0.6289       0.6157       0.6254       0.6349       0.5772       0.4714       0.5514       0.5655       0.5591       0.5587       0.5581       0.5196       0.4714       0.8686       0.8697       0.8128       0.7932       0.8166       0.8088       0.4714       0.6945       0.6998       0.6988       0.6877       0.6838       0.6316       0.4714 
      0.4912       0.5108       0.5126       0.5078       0.5213       0.4774       0.4969       0.6284       0.6560       0.6516       0.6539       0.6691       0.6052       0.4969       0.5747       0.5908       0.5892       0.5870       0.5878       0.5480       0.4969       0.9026       0.9042       0.8412       0.8367       0.8426       0.8364       0.4969       0.7371       0.7255       0.7274       0.7153       0.7093       0.6728       0.4969 
      0.5269       0.5400       0.5446       0.5336       0.5419       0.4979       0.5227       0.6680       0.6883       0.6842       0.6767       0.6961       0.6363       0.5227       0.6046       0.6224       0.6144       0.6130       0.6206       0.5747       0.5227       0.9330       0.9419       0.8787       0.8645       0.8754       0.8688       0.5227       0.7726       0.7551       0.7531       0.7439       0.7432       0.6994       0.5227 
      0.5518       0.5658       0.5700       0.5640       0.5748       0.5305       0.5489       0.6988       0.7181       0.7161       0.7068       0.7256       0.6645       0.5489       0.6365       0.6504       0.6467       0.6378       0.6556       0.6049       0.5489       0.9646       0.9777       0.9113       0.8913       0.9158       0.8942       0.5489       0.8027       0.7847       0.7850       0.7690       0.7766       0.7325       0.5489 
      0.5779       0.5943       0.5932       0.5893       0.6035       0.5652       0.5754       0.7266       0.7522       0.7460       0.7358       0.7557       0.7020       0.5754       0.6654       0.6818       0.6754       0.6630       0.6850       0.6364       0.5754       0.9973        1.006       0.9451       0.9263       0.9525       0.9287       0.5754       0.8368       0.8248       0.8162       0.7941       0.8060       0.7709       0.5754 
      0.6074       0.6236       0.6279       0.6114       0.6292       0.5905       0.6022       0.7546       0.7850       0.7789       0.7693       0.7812       0.7340       0.6022       0.6982       0.7100       0.7023       0.6932       0.7106       0.6638       0.6022        1.030        1.040       0.9839       0.9538       0.9828       0.9659       0.6022       0.8734       0.8559       0.8474       0.8360       0.8366       0.7953       0.6022 
      0.6336       0.6551       0.6514       0.6379       0.6639       0.6240       0.6294       0.7892       0.8179       0.8068       0.7906       0.8119       0.7703       0.6294       0.7325       0.7425       0.7314       0.7272       0.7382       0.7052       0.6294        1.066        1.076        1.024       0.9916        1.019        1.008       0.6294       0.9029       0.8895       0.8829       0.8661       0.8676       0.8282       0.6294 
      0.6703       0.6819       0.6759       0.6679       0.6917       0.6549       0.6570       0.8161       0.8474       0.8403       0.8226       0.8439       0.7979       0.6570       0.7633       0.7670       0.7653       0.7529       0.7681       0.7314       0.6570        1.110        1.112        1.053        1.024        1.049        1.049       0.6570       0.9336       0.9261       0.9144       0.8940       0.8952       0.8613       0.6570 
      0.6965       0.7102       0.7084       0.6980       0.7248       0.6826       0.6850       0.8442       0.8800       0.8708       0.8438       0.8694       0.8260       0.6850       0.7914       0.8052       0.7941       0.7756       0.7970       0.7630       0.6850        1.147        1.155        1.086        1.061        1.084        1.085       0.6850       0.9688       0.9547       0.9386       0.9319       0.9327       0.8950       0.6850 
      0.7232       0.7468       0.7338       0.7254       0.7522       0.7083       0.7133       0.8798       0.9172       0.8935       0.8746       0.9095       0.8560       0.7133       0.8204       0.8388       0.8205       0.8041       0.8267       0.7911       0.7133        1.180        1.189        1.114        1.099        1.119        1.123       0.7133        1.009       0.9963       0.9671       0.9620       0.9678       0.9304       0.7133 
      0.7495       0.7763       0.7668       0.7497       0.7859       0.7302       0.7421       0.9164       0.9432       0.9248       0.9047       0.9450       0.8887       0.7421       0.8535       0.8777       0.8466       0.8321       0.8550       0.8137       0.7421        1.212        1.221        1.155        1.133        1.150        1.157       0.7421        1.048        1.022       0.9991       0.9929        1.001       0.9607       0.7421 
      0.7826       0.8117       0.7878       0.7762       0.8221       0.7602       0.7713       0.9436       0.9713       0.9528       0.9303       0.9820       0.9261       0.7713       0.8830       0.9044       0.8738       0.8624       0.8912       0.8490       0.7713        1.249        1.264        1.189        1.164        1.184        1.187       0.7713        1.091        1.058        1.033        1.023        1.035       0.9949       0.7713 
      0.8130       0.8442       0.8172       0.8018       0.8530       0.7864       0.8010       0.9785        1.006       0.9848       0.9638        1.016       0.9654       0.8010       0.9167       0.9330       0.9026       0.8863       0.9353       0.8819       0.8010        1.290        1.297        1.228        1.196        1.219        1.220       0.8010        1.118        1.104        1.068        1.049        1.066        1.030       0.8010 
      0.8387       0.8755       0.8465       0.8250       0.8896       0.8304       0.8310        1.011        1.047        1.017        1.003        1.050       0.9948       0.8310       0.9482       0.9670       0.9297       0.9123       0.9658       0.9187       0.8310        1.330        1.345        1.259        1.229        1.258        1.261       0.8310        1.148        1.138        1.097        1.080        1.099        1.063       0.8310 
      0.8710       0.9004       0.8699       0.8537       0.9114       0.8652       0.8616        1.050        1.085        1.049        1.033        1.090        1.029       0.8616       0.9749        1.004       0.9547       0.9377       0.9952       0.9567       0.8616        1.368        1.385        1.290        1.266        1.290        1.300       0.8616        1.177        1.179        1.133        1.113        1.136        1.100       0.8616 
      0.9040       0.9328       0.8946       0.8905       0.9499       0.9006       0.8926        1.089        1.117        1.077        1.070        1.124        1.064       0.8926        1.007        1.039       0.9875       0.9832        1.036       0.9869       0.8926        1.414        1.417        1.317        1.299        1.321        1.338       0.8926        1.209        1.217        1.167        1.145        1.170        1.129       0.8926 
      0.9353       0.9661       0.9235       0.9211       0.9888       0.9354       0.9241        1.132        1.158        1.112        1.104        1.159        1.088       0.9241        1.042        1.075        1.023        1.015        1.073        1.023       0.9241        1.449        1.451        1.347        1.330        1.357        1.383       0.9241        1.255        1.255        1.198        1.178        1.206        1.164       0.9241 
      0.9736        1.008       0.9549       0.9538        1.020       0.9662       0.9561        1.173        1.196        1.144        1.135        1.194        1.129       0.9561        1.080        1.109        1.055        1.051        1.107        1.055       0.9561        1.497        1.488        1.378        1.379        1.397        1.421       0.9561        1.285        1.289        1.229        1.218        1.241        1.202       0.9561 
       1.004        1.039       0.9866       0.9907        1.055        1.000       0.9886        1.206        1.237        1.182        1.166        1.226        1.173       0.9886        1.118        1.142        1.090        1.087        1.140        1.085       0.9886        1.550        1.534        1.419        1.419        1.437        1.463       0.9886        1.332        1.329        1.273        1.257        1.286        1.241       0.9886 
       1.030        1.068        1.029        1.026        1.082        1.029        1.022        1.248        1.266        1.218        1.205        1.256        1.214        1.022        1.154        1.178        1.123        1.117        1.181        1.121        1.022        1.589        1.575        1.453        1.460        1.485        1.503        1.022        1.383        1.366        1.323        1.295        1.322        1.277        1.022 
       1.063        1.105        1.056        1.051        1.120        1.060        1.055        1.285        1.307        1.250        1.253        1.290        1.250        1.055        1.184        1.204        1.162        1.150        1.215        1.154        1.055        1.637        1.610        1.493        1.485        1.532        1.544        1.055        1.416        1.397        1.356        1.329        1.362        1.317        1.055 
       1.100        1.140        1.087        1.087        1.155        1.089        1.089        1.324        1.343        1.283        1.286        1.331        1.288        1.089        1.227        1.246        1.201        1.186        1.246        1.199        1.089        1.687        1.668        1.534        1.525        1.570        1.581        1.089        1.451        1.434        1.399        1.368        1.391        1.356        1.089 
       1.139        1.172        1.132        1.128        1.190        1.134        1.124        1.363        1.385        1.320        1.322        1.373        1.331        1.124        1.269        1.286        1.244        1.229        1.280        1.241        1.124        1.733        1.717        1.581        1.567        1.608        1.620        1.124        1.500        1.482        1.434        1.417        1.424        1.398        1.124 
       1.170        1.206        1.163        1.168        1.219        1.178        1.160        1.407        1.417        1.371        1.359        1.411        1.367        1.160        1.310        1.331        1.281        1.269        1.313        1.278        1.160        1.789        1.760        1.630        1.614        1.659        1.661        1.160        1.546        1.526        1.472        1.451        1.468        1.437        1.160 
       1.222        1.245        1.202        1.206        1.254        1.217        1.196        1.437        1.456        1.407        1.398        1.454        1.406        1.196        1.350        1.370        1.318        1.304        1.352        1.310        1.196        1.830        1.803        1.676        1.658        1.714        1.699        1.196        1.596        1.564        1.520        1.481        1.518        1.476        1.196 
       1.266        1.281        1.238        1.242        1.284        1.254        1.232        1.466        1.506        1.451        1.445        1.504        1.446        1.232        1.394        1.408        1.358        1.345        1.396        1.356        1.232        1.865        1.838        1.726        1.697        1.754        1.751        1.232        1.641        1.605        1.565        1.521        1.560        1.514        1.232 
       1.304        1.328        1.281        1.277        1.331        1.289        1.270        1.506        1.546        1.495        1.489        1.549        1.482        1.270        1.431        1.449        1.395        1.382        1.432        1.392        1.270        1.917        1.891        1.765        1.734        1.794        1.794        1.270        1.682        1.648        1.605        1.566        1.602        1.557        1.270 
       1.345        1.363        1.325        1.327        1.368        1.328        1.308        1.554        1.588        1.540        1.535        1.588        1.523        1.308        1.467        1.495        1.435        1.433        1.488        1.427        1.308        1.955        1.942        1.799        1.798        1.848        1.841        1.308        1.732        1.690        1.653        1.614        1.636        1.593        1.308 
       1.381        1.400        1.374        1.364        1.404        1.359        1.347        1.606        1.632        1.580        1.574        1.633        1.570        1.347        1.511        1.535        1.473        1.472        1.526        1.465        1.347        2.001        1.985        1.846        1.846        1.899        1.876        1.347        1.782        1.736        1.693        1.665        1.691        1.636        1.347 
       1.410        1.446        1.408        1.399        1.447        1.403        1.386        1.660        1.664        1.624        1.624        1.677        1.620        1.386        1.554        1.572        1.523        1.515        1.558        1.508        1.386        2.053        2.032        1.895        1.894        1.949        1.933        1.386        1.839        1.784        1.740        1.713        1.744        1.676        1.386 
       1.453        1.477        1.456        1.449        1.502        1.449        1.427        1.700        1.697        1.669        1.675        1.722        1.657        1.427        1.601        1.613        1.563        1.555        1.608        1.550        1.427        2.117        2.069        1.928        1.938        1.997        1.968        1.427        1.875        1.834        1.773        1.758        1.782        1.724        1.427 
       1.496        1.521        1.502        1.491        1.542        1.490        1.468        1.758        1.736        1.719        1.720        1.763        1.711        1.468        1.657        1.650        1.614        1.593        1.653        1.593        1.468        2.176        2.116        1.973        1.989        2.038        2.010        1.468        1.924        1.879        1.810        1.800        1.832        1.762        1.468 
       1.556        1.561        1.548        1.541        1.582        1.537        1.510        1.794        1.788        1.757        1.767        1.810        1.751        1.510        1.712        1.681        1.662        1.647        1.701        1.648        1.510        2.226        2.161        2.024        2.035        2.078        2.066        1.510        1.980        1.922        1.860        1.845        1.891        1.809        1.510 
       1.613        1.601        1.586        1.585        1.637        1.582        1.553        1.844        1.838        1.798        1.807        1.856        1.799        1.553        1.759        1.742        1.698        1.703        1.744        1.697        1.553        2.281        2.226        2.069        2.085        2.121        2.111        1.553        2.040        1.956        1.901        1.906        1.933        1.856        1.553 
       1.656        1.640        1.620        1.635        1.681        1.627        1.597        1.902        1.888        1.837        1.853        1.896        1.837        1.597        1.799        1.780        1.741        1.753        1.786        1.740        1.597        2.334        2.276        2.120        2.130        2.158        2.167        1.597        2.102        2.005        1.938        1.952        1.974        1.897        1.597 
       1.703        1.694        1.659        1.681        1.718        1.661        1.642        1.962        1.940        1.876        1.899        1.943        1.881        1.642        1.848        1.818        1.776        1.798        1.836        1.786        1.642        2.385        2.340        2.174        2.188        2.211        2.215        1.642        2.161        2.060        1.995        2.002        2.019        1.948        1.642 
       1.746        1.730        1.699        1.725        1.757        1.703        1.688        2.012        1.995        1.929        1.955        1.993        1.931        1.688        1.909        1.866        1.818        1.842        1.882        1.822        1.688        2.436        2.390        2.221        2.233        2.271        2.263        1.688        2.224        2.111        2.047        2.047        2.062        1.994        1.688 
       1.792        1.780        1.734        1.775        1.794        1.750        1.735        2.067        2.045        1.976        2.011        2.044        1.992        1.735        1.964        1.913        1.865        1.888        1.914        1.866        1.735        2.492        2.442        2.278        2.283        2.319        2.324        1.735        2.274        2.159        2.089        2.102        2.110        2.056        1.735 
       1.846        1.830        1.768        1.816        1.839        1.791        1.783        2.132        2.093        2.028        2.055        2.090        2.040        1.783        2.012        1.973        1.913        1.944        1.958        1.910        1.783        2.542        2.508        2.327        2.338        2.370        2.377        1.783        2.333        2.219        2.142        2.145        2.156        2.106        1.783 
       1.909        1.880        1.835        1.867        1.890        1.840        1.833        2.183        2.146        2.069        2.096        2.147        2.085        1.833        2.071        2.020        1.959        1.995        2.008        1.968        1.833        2.598        2.566        2.390        2.391        2.421        2.434        1.833        2.380        2.287        2.195        2.200        2.213        2.168        1.833 
       1.968        1.916        1.883        1.914        1.941        1.897        1.883        2.248        2.194        2.132        2.153        2.188        2.142        1.883        2.140        2.065        2.008        2.039        2.059        2.021        1.883        2.686        2.613        2.436        2.463        2.497        2.492        1.883        2.436        2.340        2.253        2.267        2.259        2.220        1.883 
       2.029        1.959        1.930        1.962        1.987        1.959        1.935        2.315        2.246        2.174        2.214        2.238        2.187        1.935        2.202        2.119        2.055        2.088        2.112        2.081        1.935        2.747        2.664        2.496        2.525        2.549        2.555        1.935        2.497        2.394        2.298        2.328        2.317        2.269        1.935 
       2.087        2.017        1.979        2.022        2.050        2.016        1.989        2.381        2.301        2.236        2.276        2.298        2.233        1.989        2.259        2.171        2.105        2.140        2.168        2.132        1.989        2.825        2.719        2.547        2.576        2.607        2.616        1.989        2.547        2.456        2.358        2.383        2.374        2.318        1.989 
       2.139        2.069        2.037        2.072        2.090        2.054        2.043        2.439        2.347        2.294        2.326        2.349        2.286        2.043        2.324        2.231        2.164        2.218        2.220        2.176        2.043        2.880        2.772        2.616        2.643        2.667        2.671        2.043        2.608        2.507        2.431        2.448        2.439        2.371        2.043 
       2.203        2.120        2.089        2.144        2.149        2.111        2.100        2.482        2.401        2.348        2.392        2.397        2.353        2.100        2.375        2.282        2.235        2.270        2.280        2.232        2.100        2.939        2.835        2.661        2.717        2.728        2.749        2.100        2.690        2.557        2.488        2.512        2.499        2.431        2.100 
       2.247        2.172        2.175        2.189        2.202        2.161        2.158        2.534        2.468        2.431        2.458        2.473        2.423        2.158        2.422        2.343        2.291        2.339        2.336        2.287        2.158        3.004        2.906        2.723        2.786        2.797        2.830        2.158        2.752        2.613        2.541        2.592        2.555        2.482        2.158 
       2.299        2.244        2.229        2.244        2.259        2.213        2.217        2.589        2.519        2.485        2.515        2.529        2.501        2.217        2.474        2.395        2.356        2.405        2.391        2.353        2.217        3.084        2.971        2.783        2.831        2.865        2.894        2.217        2.813        2.674        2.599        2.647        2.617        2.550        2.217 
       2.355        2.308        2.271        2.324        2.317        2.267        2.279        2.651        2.573        2.543        2.591        2.587        2.558        2.279        2.530        2.469        2.420        2.465        2.464        2.412        2.279        3.148        3.049        2.855        2.896        2.922        2.961        2.279        2.872        2.743        2.660        2.709        2.682        2.615        2.279 
       2.397        2.360        2.334        2.386        2.379        2.351        2.342        2.724        2.644        2.598        2.648        2.651        2.608        2.342        2.602        2.539        2.480        2.531        2.520        2.488        2.342        3.227        3.128        2.913        2.960        3.001        3.036        2.342        2.934        2.801        2.723        2.770        2.747        2.710        2.342 
       2.469        2.431        2.401        2.455        2.447        2.426        2.408        2.782        2.712        2.661        2.721        2.713        2.681        2.408        2.660        2.588        2.546        2.593        2.601        2.556        2.408        3.313        3.193        2.979        3.016        3.063        3.104        2.408        3.003        2.870        2.793        2.817        2.807        2.781        2.408 
       2.540        2.498        2.491        2.523        2.512        2.490        2.476        2.855        2.783        2.721        2.778        2.787        2.765        2.476        2.726        2.655        2.609        2.653        2.653        2.637        2.476        3.412        3.256        3.060        3.098        3.138        3.182        2.476        3.070        2.942        2.868        2.888        2.864        2.859        2.476 
       2.604        2.563        2.547        2.566        2.569        2.573        2.546        2.924        2.847        2.789        2.849        2.880        2.839        2.546        2.794        2.725        2.678        2.717        2.711        2.703        2.546        3.521        3.337        3.160        3.168        3.201        3.255        2.546        3.165        3.022        2.952        2.950        2.955        2.928        2.546 
       2.675        2.644        2.604        2.640        2.646        2.651        2.619        3.016        2.921        2.893        2.918        2.955        2.916        2.619        2.871        2.800        2.743        2.779        2.792        2.783        2.619        3.632        3.429        3.254        3.264        3.294        3.321        2.619        3.261        3.091        3.020        3.022        3.048        3.019        2.619 
       2.747        2.704        2.672        2.711        2.724        2.724        2.694        3.092        3.024        2.972        3.000        3.027        3.002        2.694        2.946        2.861        2.827        2.847        2.869        2.878        2.694        3.733        3.498        3.327        3.349        3.387        3.407        2.694        3.386        3.177        3.107        3.090        3.123        3.101        2.694 
       2.817        2.786        2.748        2.779        2.806        2.809        2.773        3.187        3.122        3.051        3.085        3.112        3.087        2.773        3.037        2.940        2.914        2.916        2.953        2.957        2.773        3.825        3.600        3.409        3.419        3.464        3.506        2.773        3.486        3.253        3.200        3.161        3.205        3.177        2.773 
       2.889        2.864        2.832        2.870        2.901        2.894        2.854        3.262        3.192        3.123        3.159        3.184        3.189        2.854        3.121        3.038        3.001        3.005        3.051        3.070        2.854        3.931        3.683        3.505        3.508        3.568        3.591        2.854        3.579        3.360        3.282        3.256        3.292        3.280        2.854 
       2.987        2.946        2.911        2.954        2.991        2.975        2.939        3.374        3.276        3.227        3.238        3.259        3.265        2.939        3.204        3.138        3.077        3.089        3.148        3.154        2.939        4.013        3.778        3.610        3.593        3.652        3.697        2.939        3.683        3.461        3.369        3.375        3.402        3.387        2.939 
       3.071        3.038        3.005        3.030        3.073        3.074        3.028        3.459        3.373        3.312        3.324        3.356        3.386        3.028        3.303        3.224        3.173        3.192        3.234        3.244        3.028        4.108        3.888        3.717        3.694        3.747        3.791        3.028        3.782        3.574        3.451        3.467        3.491        3.495        3.028 
       3.189        3.121        3.093        3.108        3.175        3.168        3.121        3.562        3.450        3.440        3.426        3.470        3.510        3.121        3.422        3.322        3.254        3.300        3.347        3.333        3.121        4.235        3.996        3.797        3.787        3.853        3.923        3.121        3.898        3.647        3.573        3.569        3.589        3.575        3.121 
       3.311        3.199        3.194        3.210        3.273        3.261        3.219        3.666        3.535        3.538        3.542        3.585        3.593        3.219        3.527        3.410        3.367        3.401        3.442        3.430        3.219        4.360        4.100        3.922        3.890        3.937        4.004        3.219        4.019        3.755        3.665        3.671        3.667        3.673        3.219 
       3.411        3.316        3.265        3.345        3.387        3.361        3.321        3.758        3.628        3.636        3.645        3.685        3.676        3.321        3.665        3.498        3.457        3.510        3.538        3.545        3.321        4.466        4.211        4.029        4.009        4.040        4.129        3.321        4.130        3.845        3.773        3.772        3.760        3.767        3.321 
       3.535        3.439        3.376        3.477        3.499        3.484        3.430        3.899        3.755        3.729        3.772        3.799        3.780        3.430        3.755        3.612        3.565        3.629        3.628        3.623        3.430        4.573        4.345        4.139        4.120        4.167        4.225        3.430        4.273        3.978        3.925        3.877        3.888        3.850        3.430 
       3.614        3.534        3.488        3.581        3.592        3.571        3.544        4.016        3.904        3.840        3.879        3.916        3.879        3.544        3.869        3.736        3.680        3.729        3.742        3.729        3.544        4.677        4.445        4.282        4.245        4.280        4.351        3.544        4.383        4.112        4.013        3.992        3.993        3.969        3.544 
       3.748        3.664        3.630        3.685        3.712        3.677        3.665        4.134        4.037        3.961        4.032        4.025        4.019        3.665        3.990        3.873        3.790        3.841        3.866        3.858        3.665        4.818        4.569        4.432        4.403        4.410        4.480        3.665        4.502        4.258        4.139        4.119        4.128        4.145        3.665 
       3.882        3.795        3.742        3.797        3.825        3.816        3.794        4.265        4.156        4.086        4.163        4.175        4.173        3.794        4.096        4.006        3.920        3.962        4.000        3.993        3.794        4.954        4.731        4.572        4.572        4.536        4.637        3.794        4.672        4.369        4.267        4.262        4.301        4.260        3.794 
       4.001        3.930        3.894        3.918        3.990        3.930        3.932        4.467        4.325        4.247        4.307        4.306        4.292        3.932        4.289        4.163        4.070        4.102        4.163        4.132        3.932        5.111        4.925        4.703        4.729        4.707        4.794        3.932        4.822        4.500        4.481        4.465        4.421        4.407        3.932 
       4.142        4.095        4.038        4.051        4.125        4.084        4.080        4.598        4.470        4.446        4.451        4.454        4.448        4.080        4.434        4.333        4.255        4.235        4.317        4.276        4.080        5.324        5.089        4.847        4.875        4.871        4.914        4.080        4.960        4.687        4.602        4.585        4.589        4.545        4.080 
       4.317        4.250        4.216        4.239        4.318        4.247        4.241        4.756        4.644        4.599        4.615        4.673        4.605        4.241        4.612        4.450        4.448        4.460        4.508        4.450        4.241        5.554        5.306        5.023        5.038        5.050        5.070        4.241        5.142        4.942        4.753        4.735        4.790        4.734        4.241 
       4.503        4.414        4.379        4.421        4.533        4.442        4.415        4.941        4.859        4.753        4.810        4.856        4.767        4.415        4.783        4.686        4.595        4.631        4.719        4.611        4.415        5.783        5.462        5.192        5.230        5.268        5.259        4.415        5.371        5.085        4.957        4.918        4.997        4.915        4.415 
       4.680        4.645        4.574        4.625        4.712        4.569        4.605        5.158        5.063        4.944        5.002        5.083        4.953        4.605        4.975        4.869        4.793        4.778        4.918        4.775        4.605        6.013        5.684        5.412        5.443        5.509        5.534        4.605        5.626        5.278        5.176        5.124        5.239        5.086        4.605 
       4.901        4.884        4.738        4.822        4.950        4.801        4.816        5.360        5.278        5.102        5.190        5.318        5.213        4.816        5.231        5.069        4.971        5.006        5.171        5.007        4.816        6.307        5.898        5.579        5.661        5.755        5.774        4.816        5.928        5.522        5.395        5.328        5.490        5.280        4.816 
       5.130        5.084        4.945        4.984        5.120        5.024        5.051        5.587        5.462        5.318        5.406        5.541        5.426        5.051        5.459        5.321        5.163        5.208        5.382        5.234        5.051        6.623        6.161        5.869        5.869        6.025        6.012        5.051        6.219        5.772        5.604        5.578        5.700        5.543        5.051 
       5.355        5.315        5.202        5.233        5.396        5.349        5.319        5.935        5.737        5.646        5.638        5.800        5.682        5.319        5.801        5.572        5.435        5.445        5.613        5.512        5.319        6.976        6.376        6.198        6.176        6.286        6.321        5.319        6.612        6.074        5.948        5.829        5.967        5.822        5.319 
       5.771        5.616        5.502        5.569        5.704        5.633        5.627        6.353        5.985        5.970        5.895        6.114        5.992        5.627        6.173        5.870        5.788        5.781        5.888        5.809        5.627        7.452        6.797        6.496        6.443        6.550        6.597        5.627        7.040        6.394        6.278        6.147        6.287        6.122        5.627 
       6.146        5.967        5.942        5.913        6.015        5.909        5.991        6.730        6.385        6.318        6.315        6.420        6.426        5.991        6.551        6.211        6.142        6.114        6.222        6.141        5.991        7.855        7.160        6.868        6.815        6.901        6.935        5.991        7.502        6.841        6.593        6.497        6.642        6.469        5.991 
       6.699        6.417        6.277        6.312        6.423        6.406        6.438        7.257        6.898        6.705        6.720        6.836        6.766        6.438        7.066        6.754        6.517        6.541        6.679        6.639        6.438        8.338        7.598        7.208        7.201        7.332        7.295        6.438        8.040        7.259        7.010        6.930        7.051        6.895        6.438 
       7.239        7.013        6.846        6.753        7.159        6.964        7.013        7.881        7.414        7.292        7.217        7.623        7.359        7.013        7.664        7.171        7.041        7.020        7.395        7.136        7.013        9.378        8.336        7.807        7.769        8.020        7.949        7.013        9.039        7.832        7.505        7.466        7.790        7.370        7.013 
       8.132        7.675        7.714        7.625        7.848        7.749        7.824        8.948        8.142        8.237        8.013        8.293        8.169        7.824        8.696        7.961        8.039        7.909        8.090        7.993        7.824        10.61        8.898        8.814        8.564        8.839        8.870        7.824        10.34        8.590        8.495        8.360        8.430        8.363        7.824 
       9.930        9.016        9.080        9.069        9.180        8.931        9.210        10.78        9.659        9.737        9.767        9.651        9.426        9.210        10.70        9.607        9.392        9.392        9.480        9.294        9.210        12.91        10.58        10.44        10.12        10.06        9.893        9.210        12.58        10.38        10.06        9.753        9.791        9.734        9.210 

       };
      
       x_mat=reshape(x_mat,99,35);
     
       if s==0;
           x=x_mat[.,1:7];
       elseif s==1 and y==0;
           x=x_mat[.,8:14];
       elseif s==1 and y==1;
           x=x_mat[.,15:21];
       elseif s==2 and y==0;
            x=x_mat[.,22:28];
       elseif s==2 and y==1;
            x=x_mat[.,29:35];
       endif;
       
       if b==1;
            for i (1,rows(x),1);
                g1=bezier2(rev(x[i,.]')~rev(seqa(1,1,cols(x))),100);
                x[i,.]=rev(g1[.,1])';
            endfor;
            for i (1,cols(x),1);
                g1=bezier2(rev(x[.,i])~rev(seqa(1,1,rows(x))),100); 
                x[.,i]=rev(g1[.,1]);
            endfor;
       endif;
       
       @ LINES BELOW MIGHT BE UNCOMMENTED FOR CHECKING THE NON-MONOTONICITY OF DATA @
       /*
       i0=0;
       for i (2,rows(x),1);
           for j (2, cols(x), 1);
             // if x[i,j] < x[i-1,j];
               if (x[i,j] - x[i-1,j])<-0.1;
               
                   print "Non-monotonocity between row "$+ftocv(i-1,0,1)$+" , which is "$+ftocv(x[i-1,j],1,5)$+" and row "$+ftocv(i,1,0)$+" , which is "$+ftocv(x[i,j],1,5)$+" in column "$+ftocv(j,1,0);
                   i0=i0+1;
               endif;
             //  if x[i,j] > x[i,j-1];
                  if  x[i,j] - x[i,j-1]>0.1;
                //   print "Non-monotonocity between column "$+ftocv(j-1,0,1)$+" and column "$+ftocv(j,1,0);
                   print "Non-monotonocity between column "$+ftocv(j-1,1,0)$+" , which is "$+ftocv(x[i-1,j],1,5)$+" and column "$+ftocv(j,1,0)$+" , which is "$+ftocv(x[i,j],1,5)$+" in row "$+ftocv(i,1,0);
                    i0=i0+1;
                   endif;
           endfor;
       endfor;
       ?;
       print i0;
        */       
      @ Finding column in x matrix which corresponds to sample size and weighting the position of n@
      
      if n le nv[rows(nv)];     
            for i (1,rows(nv),1);        
                if i==1;
                    if n le nv[1];
                        c=1;
                        w=1;
                        break;
                    endif;
                elseif i gt 1;
                    if n gt nv[i-1] and n le nv[i];
                        c=i; 
                        w=(n-nv[i-1])/nv[i];
                        break;
                    endif;
                endif;
            endfor;
       elseif n gt nv[rows(nv)];
            c=rows(nv); 
            w=(n-nv[c])/n;           
       endif;

      @ Finding row in x matrix which corresponds to the empirical statistic and weighting its  position@
     if t le x[rows(x),c];
        for i (1,rows(x),1);      
            if i==1;
                if t le x[i,c];
                    p=q[1];
                    break; 
                endif;
            elseif i gt 1;                         
                if (t gt x[i-1,c]) and (t le x[i,c]);
                    p=q[i-1]+w*(q[i]-q[i-1]);
                    break; 
                endif;
            endif;
        endfor;
     elseif t gt x[rows(x),c];
        v=x[rows(x),c]/t;
        p=v*q[rows(q)];

        if p lt cdfchic(t,2);
            p=w*p+(1-w)*cdfchic(t,2);
        endif;
     endif;
 
retp(p);
endp;

proc (1)= LM_pv_AR (t,s,y,n,b);
    /*
      This is the first go at the procedure for 
      approximation of p-values on the LMn,p and LMn test for the AR case.
      It approximates the distribution for the 
      actual ample size and then approximate p-values from the simulated cdf.
      Simple linear approximation is used here.
    
      In this version, the cdf has been approximated by the Monte Carlo simulation
      using program AR_3_GA_MC_1_5_A_test.gss, run on the University of Leicester HPC cluster Alice between.
    
      The assembler used for creating the x_mat was AR_DAR_3_size_Assembler_1_test_1a.gss, where switch_size_matrix=1.
    
      Inputs:
      t: the empiricald LMn,p or LMn statistic
      s: switch_sup in the main program, that is:
         if 0: LMn,p test is used
         if 1: LMn test is used with narrow shuffle limits around 1
         if 2: LMn test is used with wide shuffle limits around 1
               
      y: if 0: there is no symmetry of in shuffle in the LMn case
         if 1: there is symmetry of in shuffle in the LMn case
         IF s=0, y MUST BE 0 AS WELL.
      n: sample size
      b: dummy for Bezier smoothing of the quantiles (1 for smoothing, 0 for using raw simulated data)
         Unsmoothed p-values are less accurate, due to possible non-monotonocities, but are quicker to compute
         Note the constant in the Bezier procedure. The higher is it, the longer computation lasts.
         It seems that 100 is a good compromise
    */
   
    local x_mat,i,nv,c,w,x,q,p,v,g1;
    q=rev(seqa(1,1,99))./100;
    nv={200,400,600,1000,1600,3500};
    
    if s==0 and y ne 0;
        ? " ******************************************************************************";
        print "   Conflict with switches in procedure LM_pv_DAR. For LMn,p test (thast is, for switch_sup=0), switch_sum must be zero. Decide what you want to use ";
        stop;
    endif;
   
     x_mat=  /* simulated quantiles for interpolation
    
  {
    0.02375      0.01797      0.02831      0.03235      0.02346      0.01613      0.02010      0.06367      0.05489      0.07073      0.05996      0.05405      0.04122      0.02010      0.05308      0.04065      0.05724      0.05264      0.04858      0.03622      0.02010       0.1305       0.1303       0.1478       0.1161       0.1147      0.09228      0.02010       0.1053      0.09830       0.1214       0.1031      0.08857      0.06484      0.02010 
     0.05041      0.04230      0.05606      0.05401      0.04336      0.03727      0.04041       0.1077      0.09081       0.1102      0.09470      0.08662      0.06976      0.04041      0.09107      0.08314      0.09342      0.09116      0.08021      0.05656      0.04041       0.1902       0.1947       0.2167       0.1876       0.1722       0.1387      0.04041       0.1807       0.1587       0.1767       0.1551       0.1456       0.1044      0.04041 
     0.07717      0.07583      0.08233      0.07964      0.06382      0.05916      0.06092       0.1517       0.1288       0.1475       0.1350       0.1150      0.09641      0.06092       0.1314       0.1143       0.1314       0.1272       0.1041      0.08696      0.06092       0.2480       0.2585       0.2742       0.2488       0.2088       0.1826      0.06092       0.2391       0.2174       0.2263       0.2019       0.1830       0.1398      0.06092 
      0.1069      0.09642       0.1063       0.1060      0.09507      0.07938      0.08164       0.1869       0.1664       0.1836       0.1671       0.1479       0.1249      0.08164       0.1677       0.1451       0.1644       0.1537       0.1371       0.1137      0.08164       0.2920       0.3175       0.3180       0.3039       0.2516       0.2213      0.08164       0.2944       0.2681       0.2785       0.2585       0.2308       0.1789      0.08164 
      0.1347       0.1143       0.1364       0.1279       0.1229       0.1016       0.1026       0.2212       0.1940       0.2141       0.2067       0.1779       0.1601       0.1026       0.1991       0.1721       0.1948       0.1861       0.1675       0.1415       0.1026       0.3465       0.3691       0.3712       0.3421       0.2978       0.2513       0.1026       0.3365       0.3094       0.3197       0.3029       0.2720       0.2085       0.1026 
      0.1608       0.1493       0.1608       0.1577       0.1485       0.1262       0.1238       0.2532       0.2268       0.2502       0.2352       0.2103       0.1829       0.1238       0.2336       0.2122       0.2258       0.2232       0.1987       0.1713       0.1238       0.3958       0.4181       0.4239       0.3773       0.3383       0.2887       0.1238       0.3868       0.3597       0.3754       0.3445       0.3162       0.2435       0.1238 
      0.1922       0.1761       0.1866       0.1818       0.1747       0.1441       0.1451       0.2858       0.2666       0.2781       0.2664       0.2461       0.2048       0.1451       0.2664       0.2443       0.2525       0.2486       0.2290       0.1961       0.1451       0.4495       0.4671       0.4768       0.4207       0.3862       0.3277       0.1451       0.4406       0.4143       0.4137       0.3834       0.3435       0.2764       0.1451 
      0.2188       0.2031       0.2129       0.2038       0.2003       0.1711       0.1668       0.3266       0.2967       0.3029       0.2893       0.2707       0.2307       0.1668       0.3027       0.2785       0.2806       0.2783       0.2576       0.2221       0.1668       0.4984       0.5088       0.5224       0.4548       0.4261       0.3653       0.1668       0.4938       0.4554       0.4621       0.4194       0.3721       0.3135       0.1668 
      0.2472       0.2261       0.2427       0.2300       0.2259       0.1936       0.1886       0.3726       0.3305       0.3286       0.3189       0.2981       0.2572       0.1886       0.3418       0.3066       0.3079       0.3032       0.2849       0.2445       0.1886       0.5487       0.5479       0.5724       0.4980       0.4624       0.4022       0.1886       0.5376       0.4886       0.5161       0.4579       0.4157       0.3451       0.1886 
      0.2755       0.2574       0.2647       0.2589       0.2467       0.2198       0.2107       0.4068       0.3695       0.3628       0.3468       0.3322       0.2954       0.2107       0.3847       0.3405       0.3392       0.3336       0.3145       0.2771       0.2107       0.5853       0.5906       0.6167       0.5445       0.4940       0.4335       0.2107       0.5841       0.5286       0.5495       0.5004       0.4561       0.3767       0.2107 
      0.3166       0.2839       0.2907       0.2808       0.2780       0.2426       0.2331       0.4403       0.4013       0.4085       0.3825       0.3586       0.3262       0.2331       0.4125       0.3690       0.3748       0.3618       0.3375       0.3050       0.2331       0.6341       0.6317       0.6628       0.5819       0.5261       0.4703       0.2331       0.6247       0.5702       0.6032       0.5362       0.4882       0.4081       0.2331 
      0.3396       0.3114       0.3223       0.3053       0.2983       0.2656       0.2557       0.4725       0.4340       0.4419       0.4087       0.3868       0.3474       0.2557       0.4437       0.4022       0.4150       0.3928       0.3688       0.3319       0.2557       0.6732       0.6797       0.7003       0.6138       0.5547       0.5030       0.2557       0.6755       0.6085       0.6438       0.5745       0.5198       0.4374       0.2557 
      0.3690       0.3337       0.3583       0.3373       0.3181       0.2911       0.2785       0.5157       0.4715       0.4891       0.4470       0.4196       0.3767       0.2785       0.4840       0.4387       0.4519       0.4225       0.4018       0.3619       0.2785       0.7135       0.7330       0.7570       0.6547       0.5866       0.5380       0.2785       0.7189       0.6476       0.6910       0.6228       0.5519       0.4735       0.2785 
      0.4046       0.3608       0.3928       0.3663       0.3538       0.3195       0.3016       0.5465       0.5058       0.5186       0.4761       0.4532       0.4047       0.3016       0.5189       0.4737       0.4911       0.4529       0.4345       0.3940       0.3016       0.7567       0.7812       0.8100       0.6905       0.6160       0.5691       0.3016       0.7796       0.7129       0.7285       0.6522       0.5846       0.4997       0.3016 
      0.4365       0.4080       0.4132       0.3931       0.3805       0.3426       0.3250       0.5829       0.5444       0.5513       0.5013       0.4892       0.4354       0.3250       0.5500       0.5119       0.5273       0.4846       0.4642       0.4134       0.3250       0.8053       0.8271       0.8578       0.7185       0.6633       0.6045       0.3250       0.8308       0.7617       0.7760       0.6895       0.6180       0.5342       0.3250 
      0.4662       0.4432       0.4477       0.4197       0.4101       0.3719       0.3487       0.6247       0.5776       0.5939       0.5294       0.5140       0.4629       0.3487       0.5850       0.5514       0.5572       0.5166       0.4985       0.4416       0.3487       0.8467       0.8795       0.8988       0.7467       0.6971       0.6370       0.3487       0.8752       0.8083       0.8180       0.7192       0.6538       0.5671       0.3487 
      0.4941       0.4736       0.4828       0.4494       0.4431       0.3938       0.3727       0.6612       0.6096       0.6354       0.5659       0.5428       0.4846       0.3727       0.6246       0.5784       0.5923       0.5429       0.5263       0.4700       0.3727       0.8874       0.9418       0.9396       0.7794       0.7384       0.6845       0.3727       0.9144       0.8569       0.8587       0.7560       0.6919       0.5960       0.3727 
      0.5182       0.5036       0.5151       0.4745       0.4705       0.4174       0.3969       0.7009       0.6463       0.6639       0.6003       0.5765       0.5154       0.3969       0.6672       0.6174       0.6295       0.5861       0.5531       0.5046       0.3969       0.9429       0.9822       0.9775       0.8201       0.7686       0.7262       0.3969       0.9663       0.9083       0.9127       0.7970       0.7297       0.6368       0.3969 
      0.5568       0.5365       0.5391       0.5075       0.4947       0.4383       0.4214       0.7391       0.6968       0.6964       0.6314       0.6107       0.5426       0.4214       0.7075       0.6687       0.6625       0.6138       0.5885       0.5332       0.4214       0.9800        1.029        1.027       0.8568       0.8211       0.7681       0.4214        1.020       0.9569       0.9492       0.8309       0.7668       0.6805       0.4214 
      0.5923       0.5740       0.5675       0.5363       0.5242       0.4633       0.4463       0.7776       0.7456       0.7389       0.6651       0.6497       0.5738       0.4463       0.7402       0.7097       0.6907       0.6417       0.6231       0.5602       0.4463        1.029        1.074        1.075       0.8969       0.8651       0.8005       0.4463        1.070       0.9936       0.9873       0.8746       0.8073       0.7120       0.4463 
      0.6234       0.6126       0.5974       0.5694       0.5598       0.4954       0.4714       0.8128       0.7888       0.7692       0.7016       0.6770       0.6012       0.4714       0.7821       0.7417       0.7303       0.6783       0.6622       0.5925       0.4714        1.075        1.120        1.111       0.9321       0.9079       0.8303       0.4714        1.114        1.042        1.032       0.9052       0.8432       0.7509       0.4714 
      0.6638       0.6505       0.6357       0.5991       0.5940       0.5210       0.4969       0.8584       0.8282       0.8071       0.7296       0.7133       0.6334       0.4969       0.8126       0.7861       0.7679       0.7111       0.6889       0.6199       0.4969        1.123        1.182        1.143       0.9655       0.9495       0.8766       0.4969        1.166        1.081        1.075       0.9504       0.8778       0.7850       0.4969 
      0.6992       0.6848       0.6629       0.6312       0.6210       0.5545       0.5227       0.8979       0.8756       0.8510       0.7613       0.7485       0.6723       0.5227       0.8533       0.8285       0.8057       0.7397       0.7232       0.6584       0.5227        1.173        1.237        1.192        1.003       0.9879       0.9085       0.5227        1.218        1.127        1.110       0.9834       0.9271       0.8236       0.5227 
      0.7301       0.7202       0.6957       0.6589       0.6460       0.5834       0.5489       0.9365       0.9078       0.8798       0.7971       0.7918       0.7043       0.5489       0.8867       0.8670       0.8413       0.7770       0.7629       0.6869       0.5489        1.228        1.290        1.243        1.044        1.033       0.9409       0.5489        1.260        1.181        1.139        1.012       0.9682       0.8631       0.5489 
      0.7624       0.7610       0.7271       0.6953       0.6771       0.6143       0.5754       0.9746       0.9515       0.9087       0.8297       0.8189       0.7339       0.5754       0.9232       0.9041       0.8724       0.8147       0.7946       0.7135       0.5754        1.279        1.333        1.282        1.088        1.081       0.9695       0.5754        1.323        1.245        1.188        1.054        1.008       0.9038       0.5754 
      0.8017       0.7890       0.7645       0.7203       0.7115       0.6462       0.6022        1.011       0.9922       0.9451       0.8627       0.8664       0.7675       0.6022       0.9630       0.9404       0.9023       0.8445       0.8246       0.7496       0.6022        1.321        1.397        1.323        1.125        1.117       0.9966       0.6022        1.357        1.302        1.241        1.095        1.059       0.9378       0.6022 
      0.8328       0.8281       0.7917       0.7531       0.7402       0.6718       0.6294        1.051        1.026       0.9792       0.8960       0.8930       0.7949       0.6294       0.9951       0.9758       0.9339       0.8769       0.8661       0.7804       0.6294        1.383        1.442        1.363        1.166        1.173        1.032       0.6294        1.413        1.365        1.287        1.158        1.096       0.9707       0.6294 
      0.8670       0.8645       0.8220       0.7813       0.7766       0.7034       0.6570        1.091        1.058        1.018       0.9358       0.9315       0.8298       0.6570        1.036        1.016       0.9646       0.9118       0.8986       0.8092       0.6570        1.429        1.500        1.412        1.219        1.214        1.072       0.6570        1.458        1.419        1.333        1.196        1.138       0.9946       0.6570 
      0.9059       0.8990       0.8523       0.8141       0.8116       0.7367       0.6850        1.123        1.097        1.058       0.9692       0.9610       0.8700       0.6850        1.074        1.061        1.001       0.9458       0.9434       0.8422       0.6850        1.481        1.558        1.468        1.270        1.254        1.113       0.6850        1.514        1.462        1.377        1.237        1.193        1.035       0.6850 
      0.9384       0.9374       0.8845       0.8462       0.8443       0.7667       0.7133        1.158        1.143        1.089        1.006        1.002       0.9003       0.7133        1.114        1.108        1.036       0.9775       0.9782       0.8817       0.7133        1.530        1.606        1.511        1.307        1.292        1.162       0.7133        1.576        1.516        1.435        1.287        1.237        1.067       0.7133 
      0.9829       0.9704       0.9204       0.8864       0.8785       0.7898       0.7421        1.202        1.184        1.120        1.044        1.039       0.9335       0.7421        1.152        1.153        1.080        1.015        1.012       0.9105       0.7421        1.572        1.664        1.557        1.358        1.331        1.198       0.7421        1.632        1.573        1.493        1.323        1.278        1.108       0.7421 
       1.023        1.005       0.9577       0.9154       0.9150       0.8322       0.7713        1.260        1.241        1.167        1.075        1.075       0.9675       0.7713        1.195        1.188        1.113        1.056        1.058       0.9440       0.7713        1.620        1.712        1.601        1.404        1.370        1.229       0.7713        1.683        1.615        1.538        1.368        1.314        1.155       0.7713 
       1.059        1.044       0.9949       0.9469       0.9441       0.8671       0.8010        1.302        1.288        1.195        1.124        1.115        1.001       0.8010        1.240        1.231        1.160        1.095        1.092       0.9756       0.8010        1.668        1.770        1.647        1.451        1.423        1.274       0.8010        1.737        1.671        1.579        1.416        1.363        1.194       0.8010 
       1.099        1.081        1.037       0.9783       0.9843       0.9022       0.8310        1.357        1.344        1.226        1.164        1.143        1.048       0.8310        1.298        1.283        1.193        1.146        1.127        1.028       0.8310        1.729        1.814        1.698        1.486        1.468        1.320       0.8310        1.803        1.728        1.620        1.469        1.401        1.234       0.8310 
       1.151        1.139        1.069        1.017        1.028       0.9357       0.8616        1.418        1.395        1.263        1.201        1.183        1.090       0.8616        1.350        1.334        1.229        1.183        1.166        1.062       0.8616        1.780        1.872        1.751        1.543        1.511        1.358       0.8616        1.865        1.770        1.667        1.517        1.442        1.268       0.8616 
       1.189        1.183        1.099        1.072        1.055       0.9738       0.8926        1.466        1.439        1.309        1.247        1.218        1.125       0.8926        1.405        1.371        1.260        1.223        1.199        1.111       0.8926        1.842        1.930        1.802        1.595        1.554        1.401       0.8926        1.927        1.813        1.713        1.560        1.490        1.316       0.8926 
       1.235        1.225        1.130        1.106        1.093        1.012       0.9241        1.509        1.483        1.353        1.293        1.264        1.164       0.9241        1.450        1.414        1.315        1.264        1.230        1.147       0.9241        1.887        1.994        1.863        1.636        1.606        1.446       0.9241        1.978        1.874        1.774        1.604        1.527        1.358       0.9241 
       1.276        1.267        1.164        1.145        1.132        1.044       0.9561        1.548        1.531        1.405        1.337        1.297        1.205       0.9561        1.496        1.468        1.353        1.306        1.266        1.184       0.9561        1.932        2.063        1.916        1.695        1.650        1.491       0.9561        2.029        1.944        1.826        1.664        1.565        1.403       0.9561 
       1.313        1.307        1.208        1.190        1.167        1.074       0.9886        1.589        1.568        1.451        1.382        1.331        1.236       0.9886        1.534        1.508        1.405        1.354        1.308        1.220       0.9886        1.980        2.124        1.969        1.751        1.700        1.532       0.9886        2.086        2.011        1.869        1.717        1.629        1.445       0.9886 
       1.353        1.350        1.252        1.228        1.205        1.106        1.022        1.628        1.612        1.503        1.421        1.375        1.277        1.022        1.581        1.555        1.442        1.402        1.353        1.250        1.022        2.033        2.191        2.015        1.806        1.737        1.577        1.022        2.156        2.075        1.927        1.772        1.668        1.491        1.022 
       1.402        1.387        1.302        1.272        1.240        1.141        1.055        1.690        1.656        1.544        1.469        1.419        1.310        1.055        1.626        1.596        1.488        1.446        1.390        1.288        1.055        2.089        2.244        2.086        1.843        1.783        1.617        1.055        2.218        2.133        1.974        1.824        1.726        1.534        1.055 
       1.449        1.423        1.339        1.307        1.286        1.183        1.089        1.736        1.701        1.601        1.512        1.466        1.352        1.089        1.678        1.645        1.536        1.483        1.438        1.327        1.089        2.142        2.312        2.154        1.896        1.826        1.653        1.089        2.282        2.181        2.020        1.880        1.782        1.578        1.089 
       1.489        1.467        1.382        1.362        1.316        1.229        1.124        1.790        1.747        1.656        1.556        1.505        1.401        1.124        1.735        1.683        1.598        1.534        1.486        1.373        1.124        2.206        2.368        2.221        1.947        1.878        1.695        1.124        2.335        2.245        2.095        1.943        1.851        1.617        1.124 
       1.536        1.519        1.427        1.400        1.366        1.268        1.160        1.851        1.794        1.704        1.596        1.563        1.445        1.160        1.785        1.725        1.633        1.569        1.526        1.410        1.160        2.264        2.429        2.272        1.991        1.936        1.739        1.160        2.397        2.310        2.156        1.996        1.907        1.667        1.160 
       1.576        1.561        1.464        1.436        1.407        1.304        1.196        1.897        1.856        1.746        1.657        1.607        1.471        1.196        1.837        1.768        1.683        1.619        1.583        1.448        1.196        2.338        2.496        2.341        2.044        1.980        1.795        1.196        2.461        2.376        2.212        2.047        1.957        1.708        1.196 
       1.630        1.603        1.516        1.482        1.445        1.338        1.232        1.962        1.904        1.797        1.702        1.653        1.512        1.232        1.894        1.827        1.725        1.675        1.632        1.492        1.232        2.408        2.550        2.413        2.095        2.030        1.850        1.232        2.542        2.431        2.261        2.110        1.997        1.749        1.232 
       1.684        1.649        1.572        1.525        1.488        1.379        1.270        2.018        1.969        1.854        1.752        1.696        1.552        1.270        1.945        1.871        1.786        1.723        1.678        1.538        1.270        2.464        2.614        2.467        2.157        2.085        1.891        1.270        2.615        2.501        2.333        2.155        2.067        1.794        1.270 
       1.736        1.693        1.616        1.559        1.532        1.416        1.308        2.063        2.015        1.919        1.798        1.736        1.608        1.308        1.992        1.940        1.843        1.769        1.725        1.590        1.308        2.546        2.678        2.527        2.215        2.142        1.933        1.308        2.696        2.568        2.403        2.207        2.112        1.846        1.308 
       1.790        1.742        1.666        1.626        1.567        1.465        1.347        2.117        2.078        1.973        1.847        1.784        1.643        1.347        2.043        2.002        1.903        1.824        1.769        1.640        1.347        2.605        2.749        2.600        2.280        2.193        1.977        1.347        2.750        2.634        2.461        2.261        2.157        1.902        1.347 
       1.847        1.802        1.723        1.670        1.632        1.520        1.386        2.159        2.146        2.021        1.901        1.839        1.685        1.386        2.099        2.075        1.959        1.877        1.815        1.671        1.386        2.679        2.819        2.668        2.327        2.250        2.035        1.386        2.816        2.692        2.522        2.322        2.226        1.941        1.386 
       1.893        1.864        1.770        1.712        1.676        1.557        1.427        2.229        2.204        2.093        1.963        1.888        1.740        1.427        2.146        2.135        2.012        1.931        1.862        1.712        1.427        2.730        2.883        2.727        2.374        2.307        2.088        1.427        2.903        2.776        2.613        2.404        2.275        1.979        1.427 
       1.950        1.926        1.825        1.773        1.731        1.590        1.468        2.284        2.273        2.140        2.015        1.950        1.787        1.468        2.214        2.193        2.077        2.005        1.910        1.755        1.468        2.793        2.975        2.797        2.429        2.358        2.146        1.468        2.979        2.855        2.675        2.467        2.345        2.033        1.468 
       2.003        1.994        1.877        1.828        1.775        1.635        1.510        2.346        2.338        2.189        2.064        1.990        1.824        1.510        2.270        2.254        2.127        2.044        1.970        1.796        1.510        2.862        3.067        2.859        2.500        2.413        2.187        1.510        3.056        2.944        2.752        2.538        2.405        2.079        1.510 
       2.053        2.040        1.929        1.889        1.828        1.685        1.553        2.409        2.389        2.242        2.127        2.055        1.877        1.553        2.337        2.313        2.170        2.092        2.031        1.840        1.553        2.941        3.137        2.927        2.574        2.484        2.234        1.553        3.140        3.014        2.816        2.595        2.460        2.146        1.553 
       2.100        2.091        1.989        1.937        1.881        1.726        1.597        2.483        2.450        2.316        2.184        2.111        1.917        1.597        2.399        2.376        2.227        2.146        2.081        1.886        1.597        3.027        3.218        2.996        2.639        2.543        2.292        1.597        3.219        3.108        2.884        2.668        2.529        2.197        1.597 
       2.176        2.147        2.053        1.989        1.930        1.772        1.642        2.556        2.503        2.375        2.233        2.173        1.961        1.642        2.465        2.416        2.315        2.213        2.126        1.934        1.642        3.100        3.301        3.081        2.708        2.616        2.338        1.642        3.312        3.193        2.945        2.745        2.598        2.263        1.642 
       2.231        2.192        2.114        2.029        1.991        1.816        1.688        2.627        2.557        2.429        2.289        2.226        2.025        1.688        2.534        2.473        2.380        2.289        2.190        1.978        1.688        3.183        3.388        3.140        2.764        2.696        2.400        1.688        3.385        3.258        3.025        2.823        2.683        2.310        1.688 
       2.283        2.238        2.170        2.074        2.039        1.856        1.735        2.696        2.617        2.515        2.354        2.295        2.078        1.735        2.610        2.528        2.437        2.350        2.271        2.055        1.735        3.265        3.488        3.232        2.824        2.765        2.475        1.735        3.452        3.332        3.117        2.902        2.761        2.381        1.735 
       2.359        2.287        2.224        2.134        2.088        1.905        1.783        2.774        2.686        2.573        2.407        2.356        2.138        1.783        2.683        2.602        2.512        2.405        2.337        2.105        1.783        3.331        3.557        3.310        2.907        2.854        2.548        1.783        3.530        3.425        3.201        2.966        2.839        2.444        1.783 
       2.424        2.343        2.291        2.185        2.144        1.963        1.833        2.843        2.749        2.633        2.464        2.415        2.195        1.833        2.758        2.674        2.576        2.469        2.404        2.166        1.833        3.423        3.627        3.395        2.996        2.921        2.603        1.833        3.638        3.513        3.285        3.051        2.917        2.519        1.833 
       2.484        2.411        2.354        2.246        2.224        2.014        1.883        2.909        2.838        2.691        2.545        2.484        2.256        1.883        2.816        2.747        2.630        2.543        2.465        2.230        1.883        3.528        3.713        3.460        3.061        2.990        2.652        1.883        3.725        3.595        3.382        3.126        3.005        2.574        1.883 
       2.556        2.481        2.408        2.322        2.264        2.085        1.935        2.990        2.907        2.760        2.616        2.547        2.326        1.935        2.900        2.811        2.705        2.603        2.533        2.303        1.935        3.652        3.818        3.576        3.119        3.071        2.726        1.935        3.838        3.692        3.442        3.218        3.076        2.650        1.935 
       2.627        2.541        2.467        2.394        2.336        2.153        1.989        3.080        2.970        2.830        2.677        2.619        2.382        1.989        2.975        2.883        2.782        2.655        2.601        2.368        1.989        3.741        3.926        3.686        3.222        3.158        2.792        1.989        3.963        3.795        3.550        3.303        3.142        2.729        1.989 
       2.690        2.617        2.547        2.460        2.404        2.211        2.043        3.181        3.057        2.900        2.754        2.705        2.445        2.043        3.064        2.969        2.845        2.719        2.685        2.427        2.043        3.829        4.058        3.796        3.301        3.229        2.875        2.043        4.066        3.898        3.657        3.392        3.208        2.794        2.043 
       2.763        2.705        2.592        2.517        2.474        2.276        2.100        3.252        3.145        2.972        2.831        2.764        2.514        2.100        3.148        3.050        2.915        2.796        2.768        2.492        2.100        3.914        4.184        3.877        3.403        3.298        2.943        2.100        4.168        4.032        3.756        3.476        3.292        2.882        2.100 
       2.863        2.778        2.660        2.579        2.549        2.348        2.158        3.353        3.224        3.044        2.906        2.854        2.564        2.158        3.234        3.129        2.980        2.875        2.841        2.548        2.158        4.011        4.308        3.979        3.486        3.383        3.017        2.158        4.281        4.171        3.838        3.578        3.408        2.957        2.158 
       2.935        2.857        2.718        2.675        2.633        2.407        2.217        3.423        3.309        3.112        2.979        2.929        2.639        2.217        3.328        3.206        3.051        2.962        2.910        2.620        2.217        4.093        4.391        4.083        3.570        3.493        3.092        2.217        4.411        4.285        3.947        3.677        3.523        3.033        2.217 
       3.013        2.927        2.789        2.739        2.687        2.471        2.279        3.521        3.393        3.190        3.053        3.009        2.718        2.279        3.414        3.291        3.126        3.026        2.981        2.691        2.279        4.200        4.473        4.216        3.695        3.594        3.181        2.279        4.534        4.377        4.059        3.769        3.611        3.110        2.279 
       3.082        3.008        2.877        2.808        2.773        2.545        2.342        3.624        3.463        3.308        3.147        3.073        2.796        2.342        3.515        3.362        3.227        3.110        3.085        2.790        2.342        4.302        4.621        4.336        3.781        3.696        3.266        2.342        4.698        4.473        4.217        3.865        3.720        3.185        2.342 
       3.177        3.103        2.946        2.903        2.850        2.619        2.408        3.709        3.577        3.411        3.236        3.163        2.878        2.408        3.602        3.464        3.330        3.209        3.162        2.866        2.408        4.414        4.788        4.458        3.913        3.790        3.346        2.408        4.854        4.611        4.347        3.982        3.820        3.270        2.408 
       3.263        3.206        3.029        2.983        2.905        2.710        2.476        3.800        3.666        3.492        3.327        3.257        2.947        2.476        3.713        3.570        3.420        3.296        3.234        2.933        2.476        4.566        4.899        4.573        4.007        3.863        3.411        2.476        5.007        4.763        4.456        4.076        3.913        3.355        2.476 
       3.350        3.277        3.123        3.070        2.975        2.794        2.546        3.934        3.759        3.577        3.426        3.329        3.041        2.546        3.809        3.663        3.510        3.381        3.321        3.008        2.546        4.700        5.058        4.701        4.093        3.998        3.498        2.546        5.159        4.937        4.576        4.205        4.048        3.435        2.546 
       3.491        3.390        3.214        3.178        3.072        2.873        2.619        4.033        3.873        3.681        3.506        3.421        3.125        2.619        3.926        3.766        3.610        3.484        3.461        3.099        2.619        4.842        5.231        4.870        4.199        4.123        3.592        2.619        5.343        5.098        4.711        4.291        4.141        3.539        2.619 
       3.588        3.475        3.326        3.270        3.163        2.956        2.694        4.148        3.972        3.796        3.625        3.514        3.216        2.694        4.050        3.871        3.724        3.589        3.518        3.184        2.694        5.041        5.375        5.017        4.324        4.242        3.694        2.694        5.500        5.258        4.861        4.411        4.273        3.633        2.694 
       3.655        3.580        3.414        3.341        3.273        3.031        2.773        4.285        4.087        3.918        3.715        3.631        3.284        2.773        4.178        3.978        3.825        3.683        3.607        3.267        2.773        5.182        5.528        5.165        4.422        4.336        3.792        2.773        5.719        5.407        5.042        4.550        4.371        3.749        2.773 
       3.765        3.656        3.492        3.429        3.387        3.109        2.854        4.415        4.198        4.049        3.832        3.734        3.381        2.854        4.315        4.095        3.974        3.801        3.710        3.354        2.854        5.337        5.685        5.314        4.522        4.435        3.897        2.854        5.897        5.575        5.179        4.705        4.494        3.849        2.854 
       3.874        3.747        3.607        3.542        3.479        3.191        2.939        4.547        4.305        4.173        3.921        3.855        3.451        2.939        4.444        4.205        4.104        3.906        3.829        3.439        2.939        5.533        5.869        5.484        4.660        4.553        4.004        2.939        6.113        5.739        5.327        4.836        4.640        3.960        2.939 
       3.994        3.847        3.714        3.637        3.597        3.284        3.028        4.698        4.450        4.299        4.054        3.955        3.542        3.028        4.558        4.354        4.216        4.028        3.926        3.539        3.028        5.705        6.047        5.660        4.817        4.658        4.112        3.028        6.319        5.924        5.507        4.979        4.745        4.111        3.028 
       4.155        3.952        3.837        3.731        3.695        3.370        3.121        4.828        4.612        4.428        4.191        4.061        3.663        3.121        4.698        4.482        4.346        4.165        4.041        3.643        3.121        5.819        6.246        5.853        4.931        4.758        4.237        3.121        6.514        6.118        5.724        5.140        4.859        4.215        3.121 
       4.280        4.137        3.985        3.829        3.805        3.493        3.219        4.980        4.776        4.582        4.307        4.156        3.772        3.219        4.843        4.660        4.486        4.318        4.149        3.744        3.219        6.029        6.436        6.108        5.065        4.902        4.336        3.219        6.786        6.303        5.977        5.337        5.002        4.307        3.219 
       4.412        4.286        4.106        3.960        3.909        3.605        3.321        5.149        4.962        4.731        4.415        4.279        3.880        3.321        5.058        4.831        4.649        4.452        4.270        3.849        3.321        6.264        6.645        6.333        5.239        5.010        4.467        3.321        7.028        6.543        6.186        5.531        5.162        4.455        3.321 
       4.571        4.434        4.232        4.102        4.016        3.707        3.430        5.371        5.137        4.865        4.550        4.411        4.016        3.430        5.210        5.007        4.788        4.582        4.411        3.958        3.430        6.464        6.856        6.597        5.401        5.166        4.583        3.430        7.258        6.765        6.441        5.726        5.313        4.607        3.430 
       4.712        4.573        4.404        4.215        4.122        3.841        3.544        5.564        5.323        5.058        4.702        4.523        4.129        3.544        5.430        5.189        4.989        4.716        4.523        4.106        3.544        6.695        7.097        6.777        5.603        5.331        4.741        3.544        7.553        6.979        6.662        5.923        5.528        4.777        3.544 
       4.883        4.731        4.580        4.326        4.261        3.965        3.665        5.751        5.510        5.248        4.824        4.658        4.277        3.665        5.614        5.339        5.127        4.854        4.652        4.241        3.665        6.987        7.308        7.038        5.804        5.493        4.921        3.665        7.889        7.216        6.902        6.147        5.726        4.923        3.665 
       5.073        4.944        4.735        4.475        4.391        4.111        3.794        5.935        5.684        5.480        4.976        4.782        4.405        3.794        5.791        5.574        5.354        4.987        4.794        4.396        3.794        7.284        7.561        7.302        6.055        5.689        5.062        3.794        8.251        7.489        7.185        6.421        5.949        5.081        3.794 
       5.254        5.118        4.923        4.624        4.516        4.239        3.932        6.168        5.866        5.652        5.125        4.944        4.558        3.932        6.015        5.737        5.574        5.160        4.983        4.571        3.932        7.554        7.852        7.609        6.286        5.951        5.232        3.932        8.680        7.761        7.452        6.701        6.215        5.281        3.932 
       5.508        5.287        5.092        4.777        4.655        4.401        4.080        6.450        6.106        5.859        5.291        5.108        4.738        4.080        6.294        5.974        5.761        5.335        5.143        4.742        4.080        7.925        8.202        7.977        6.523        6.168        5.404        4.080        8.998        8.089        7.846        7.026        6.461        5.454        4.080 
       5.766        5.479        5.329        4.983        4.822        4.565        4.241        6.772        6.305        6.092        5.539        5.319        4.967        4.241        6.561        6.167        6.016        5.604        5.333        4.922        4.241        8.302        8.685        8.314        6.812        6.390        5.631        4.241        9.547        8.545        8.193        7.344        6.728        5.649        4.241 
       5.984        5.689        5.525        5.219        5.033        4.725        4.415        7.065        6.526        6.339        5.796        5.525        5.137        4.415        6.843        6.375        6.232        5.864        5.565        5.112        4.415        8.666        9.053        8.761        7.144        6.622        5.898        4.415        9.976        8.941        8.620        7.699        7.008        5.946        4.415 
       6.308        5.942        5.774        5.505        5.247        4.961        4.605        7.401        6.790        6.594        6.072        5.756        5.341        4.605        7.230        6.682        6.512        6.145        5.775        5.360        4.605        9.146        9.552        9.151        7.393        6.921        6.159        4.605        10.45        9.383        9.014        8.015        7.296        6.206        4.605 
       6.674        6.193        5.987        5.770        5.519        5.247        4.816        7.764        7.141        6.877        6.411        6.035        5.705        4.816        7.605        6.993        6.798        6.469        6.081        5.651        4.816        9.552        10.10        9.627        7.723        7.289        6.448        4.816        11.08        10.02        9.501        8.429        7.647        6.539        4.816 
       6.981        6.462        6.327        6.091        5.824        5.556        5.051        8.271        7.568        7.279        6.688        6.368        5.966        5.051        8.077        7.388        7.191        6.723        6.390        5.987        5.051        10.25        10.96        10.15        8.144        7.610        6.727        5.051        11.76        10.76        10.00        8.946        8.090        6.828        5.051 
       7.406        6.836        6.683        6.357        6.167        5.907        5.319        8.785        7.981        7.639        7.055        6.807        6.318        5.319        8.555        7.775        7.536        7.089        6.827        6.310        5.319        10.85        11.64        10.82        8.546        8.110        7.123        5.319        12.78        11.50        10.68        9.462        8.593        7.296        5.319 
       7.902        7.338        7.023        6.752        6.565        6.185        5.627        9.241        8.563        8.094        7.371        7.157        6.644        5.627        8.990        8.364        8.032        7.459        7.173        6.643        5.627        11.69        12.52        11.59        8.984        8.691        7.493        5.627        13.84        12.29        11.39        10.32        9.193        7.666        5.627 
       8.550        7.971        7.667        7.223        6.993        6.568        5.991        10.36        9.182        8.824        7.878        7.551        7.040        5.991        10.08        8.948        8.638        8.004        7.651        7.028        5.991        12.83        13.74        12.68        9.670        9.225        7.973        5.991        14.88        13.63        12.59        11.03        9.952        8.160        5.991 
       9.587        8.675        8.298        7.730        7.589        7.053        6.438        11.47        10.28        9.511        8.641        8.259        7.520        6.438        11.11        9.940        9.447        8.803        8.333        7.516        6.438        14.10        15.17        13.72        10.62        9.988        8.543        6.438        16.73        15.04        13.56        12.10        10.76        8.879        6.438 
       10.90        9.583        9.362        8.488        8.367        7.706        7.013        12.84        11.56        10.62        9.442        9.164        8.256        7.013        12.55        11.20        10.42        9.740        9.309        8.369        7.013        16.31        17.15        15.48        11.93        11.03        9.544        7.013        19.55        16.97        15.35        13.67        11.62        9.867        7.013 
       12.43        10.63        10.41        9.318        9.611        8.718        7.824        15.29        12.85        12.24        10.61        10.32        9.571        7.824        14.79        12.55        12.15        10.78        10.58        9.585        7.824        19.24        19.70        18.01        13.36        12.18        11.04        7.824        23.53        19.53        17.91        15.94        13.74        11.93        7.824 
       15.57        13.15        12.15        11.12        10.98        10.63        9.210        18.59        15.96        14.77        12.71        12.08        11.57        9.210        18.27        15.52        14.59        12.96        12.38        11.78        9.210        24.71        25.01        22.45        16.87        14.92        13.84        9.210        31.25        24.78        22.28        20.05        16.73        14.97        9.210 
       };
      
       x_mat=reshape(x_mat,99,35);
     
       if s==0;
           x=x_mat[.,1:7];
       elseif s==1 and y==0;
           x=x_mat[.,8:14];
       elseif s==1 and y==1;
           x=x_mat[.,15:21];
       elseif s==2 and y==0;
            x=x_mat[.,22:28];
       elseif s==2 and y==1;
            x=x_mat[.,29:35];
       endif;
       
       if b==1;
            for i (1,rows(x),1);
                g1=bezier2(rev(x[i,.]')~rev(seqa(1,1,cols(x))),100);
                x[i,.]=rev(g1[.,1])';
            endfor;
            for i (1,cols(x),1);
                g1=bezier2(rev(x[.,i])~rev(seqa(1,1,rows(x))),100); 
                x[.,i]=rev(g1[.,1]);
            endfor;
       endif;
       
       @ LINES BELOW MIGHT BE UNCOMMENTED FOR CHECKING THE NON-MONOTONICITY OF DATA @
       /*
       i0=0;
       for i (2,rows(x),1);
           for j (2, cols(x), 1);
             // if x[i,j] < x[i-1,j];
               if (x[i,j] - x[i-1,j])<-0.1;
               
                   print "Non-monotonocity between row "$+ftocv(i-1,0,1)$+" , which is "$+ftocv(x[i-1,j],1,5)$+" and row "$+ftocv(i,1,0)$+" , which is "$+ftocv(x[i,j],1,5)$+" in column "$+ftocv(j,1,0);
                   i0=i0+1;
               endif;
             //  if x[i,j] > x[i,j-1];
                  if  x[i,j] - x[i,j-1]>0.1;
                //   print "Non-monotonocity between column "$+ftocv(j-1,0,1)$+" and column "$+ftocv(j,1,0);
                   print "Non-monotonocity between column "$+ftocv(j-1,1,0)$+" , which is "$+ftocv(x[i-1,j],1,5)$+" and column "$+ftocv(j,1,0)$+" , which is "$+ftocv(x[i,j],1,5)$+" in row "$+ftocv(i,1,0);
                    i0=i0+1;
                   endif;
           endfor;
       endfor;
       ?;
       print i0;
        */       
      @ Finding column in x matrix which corresponds to sample size and weighting the position of n@
      
      if n le nv[rows(nv)];     
            for i (1,rows(nv),1);        
                if i==1;
                    if n le nv[1];
                        c=1;
                        w=1;
                        break;
                    endif;
                elseif i gt 1;
                    if n gt nv[i-1] and n le nv[i];
                        c=i; 
                        w=(n-nv[i-1])/nv[i];
                        break;
                    endif;
                endif;
            endfor;
       elseif n gt nv[rows(nv)];
            c=rows(nv); 
            w=(n-nv[c])/n;           
       endif;

      @ Finding row in x matrix which corresponds to the empirical statistic and weighting its  position@
     if t le x[rows(x),c];
        for i (1,rows(x),1);      
            if i==1;
                if t le x[i,c];
                    p=q[1];
                    break; 
                endif;
            elseif i gt 1;                         
                if (t gt x[i-1,c]) and (t le x[i,c]);
                    p=q[i-1]+w*(q[i]-q[i-1]);
                    break; 
                endif;
            endif;
        endfor;
     elseif t gt x[rows(x),c];
        v=x[rows(x),c]/t;
        p=v*q[rows(q)];

        if p lt cdfchic(t,2);
            p=w*p+(1-w)*cdfchic(t,2);
        endif;
     endif;
 
retp(p);
endp;


proc (3) = t_means_test_bootstrapped_new(x,y,d,v,h);
    /*
    Bootstrapped version of the t_means_test
    if d=0: Test for differences in means in case where population variances are 'similar' 
             in the sense of the Behrens-Fisher problem. If differences in sample variances are 
             'big', computations does not stop, but warning is printed
    if d=1:  Test for differences in pairs ('after treatment problem') is computed
    
    if v=1: the test with equal variance
    if v=2: the test with different variances
    
    Sources: 
    if d=0: Efron, B.; Tibshirani, R. (1993)' An Introduction to the Bootstrap. Boca Raton, FL: Chapman & Hall/CRC.
    if d=1: Konietschke, F; Pauly, M. (2014),   'Bootstrapping and permuting paired t-test type statistics', Stat Comput 24:283296
    
    h:  Decides on the alternative hypothesis
        if 0: two: sided (reject for small and large t-values)
        if 1; right-hand side one-sided (reject for large t-values)
        if -1 left-hand sided (reject for small t-values)
    
    */
    local ndraws,t,tstar,i,n1,n2,df,x1,y1,z,xdraw,ydraw,bstar;
    local pv,b,xn,yn;
    
    rndseed 195467;    
                       @ For any sort of Monte Carlo or repetitive simulation excercise, block the line above@
    ndraws=1000;
    n1=rows(x);
    n2=rows(y);
    {t,b}=t_means_test_new(x,y,d,v,h);
    if d==0;
        z=meanc(x|y); 
        xn=(stdc(x)^2)/n1;
        yn=(stdc(y)^2)/n2;
        
        if v==1;
            df=n1+n2-2;
        elseif v==2;
            df=floor(((xn+yn)^2)/(((xn^2)/(n1-1))+((yn^2)/(n2-1))));
        endif;
              
        elseif d==1;
        z=0;
        df=n1-1;
    endif;
    x1=x-meanc(x)+z;
    y1=y-meanc(y)+z;
    tstar=zeros(ndraws,1);
    for i (1,ndraws,1);
        xdraw=sampleData(x1,n1,1); 
        ydraw=sampleData(y1,n1,1); 
        {tstar[i],bstar}=t_means_test_new(xdraw,ydraw,d, v,h);
    endfor;
  
    if h==0; 
        if t gt 0;
            pv=(sumc(tstar.>t))./ndraws;
        else;
            pv=(sumc(tstar.<t))./ndraws;
        endif; 
    elseif h==1;
        pv=(sumc(tstar.>t))./ndraws;
    elseif h==-1;
        pv=(sumc(tstar.<t))./ndraws;    
    endif;   
    retp (t,cdfTc(abs(t),df),pv);
endp;

proc (2) = corr_boot(x,y);
    local t,r,rstar,u,ind,e,ndraws,xdraw,ts,pv;
    ndraws=100;
    t=corrx(x~y);
    r=t[1,2];
    rstar = zeros(ndraws,1);
    for i (1,ndraws,1);
        u=rndu(rows(x),1); 
       ind=ceil(rows(x).*u);
       e=ind .eq 0;
       ind=substute(ind,e,1);
       xdraw=x[ind];
       ts=corrx(xdraw~y);
        rstar[i]=ts[1,2];
    endfor;
    if r gt 0;
        pv=(sumc(rstar.>r))./ndraws;
    else;
        pv=(sumc(rstar.<r))./ndraws;
    endif;
    retp (r,pv);
endp;



proc (1)=stab_ar_k(b);
    local c,r;
    c=rev(b)|(-1);    // All roots of b_k*Z^k+b_(k-1)*Z*(k-1)+...+b_1*Z-1=0 must be ouside the unit circle  
    r=polyroot(c); 
    if minc(abs(r)) le 1;
        ?;
        print "WARNING: Initial values give non-stationary process";
        ?;
    endif;
    retp (minc(abs(r)));
endp; 
     

proc (2) = crit_sup_arg(s,x,res,cv,p_lim,n_mc,n_s,sv);
	/* This procedure computes customized critical values 
		for LM,n (that is, 'supremum') test for ARMA-GARCH
		inputs:
		s:  		LM,n statistic
		x,res,cv: 	data, residuals and conditional variance
		p_lim:		matrix 2 x 3 of lower and upper limits for m,k, and rho
		n_mc: 		number of 'Monte Carlo' replications
		n_s: 		number of drawings of m,k and rho
	
		outputs:
		(1):	   1 x 3 vector of critical values, respectively 90%, 95% and 99%
		(2):	   pvalue of the LM,n statistic
	*/
    
	local v_mc,D_m,D_s,i,j,n,w,pz,g,M_1,M_2,M_3,I_p,M_p,M,LMp_v;
	local LM_v,pval;
	v_mc=zeros(n_mc,1);
	sv=round(rndu(1,4).*100); 
    sv=sv.*100;
	{D_m,D_s} =D_ms(x,res,cv);//D_hat,m,t and D_hat_sigma_t
	n=cols(D_m);
	LM_v=zeros(n_mc,1);
	for i (1,n_mc,1);
		w=rndn(n,1);
		M_1=sumc(w.*D_m')./sqrt(n);            //part 1 of (S1)
		M_2=sumc((w^2-1).*D_s')./sqrt(n);      //part 2 of (S1)
		LMp_v=zeros(n_s,1);
		for j (1,n_s,1);
			pz=p_lim[1,.]+rndu(1,3).*(p_lim[2,.]-p_lim[1,.]);
			{I_p,M_p}=I_pm_arga(x,res,cv,pz);	
			g=g_p(w, pz);				
			M_3=sumc(g)./sqrt(n);              //part 3 of (S1)
			M=M_p*(M_1|M_2|M_3);				
			LMp_v[j]=M[1]^2+M[2]^2;                //(S2)
		endfor;
		LM_v[i]=maxc(LMp_v);
	endfor;
	pval=sumc(LM_v.>s)./n_mc;
	retp(quantile(LM_v,0.90)~quantile(LM_v,0.95)~quantile(LM_v,0.99),pval);
endp;

proc (2) = crit_sup_dar(s,x,res,cv,p_lim,n_mc,n_s,sv);
	/* This procedure computes customized critical values 
		for LM,n (that is, 'supremum') test for ARMA-GARCH
		inputs:
		s:  		LM,n statistic
		x,res,cv: 	data, residuals and conditional variance
		p_lim:		matrix 2 x 3 of lower and upper limits for m,k, and rho
		n_mc: 		number of 'Monte Carlo' replications
		n_s: 		number of drawings of m,k and rho
	
		outputs:
		(1):	   1 x 3 vector of critical values, respectively 90%, 95% and 99%
		(2):	   pvalue of the LM,n statistic
	*/
	local v_mc,D_m,D_s,i,j,n,w,pz,g,M_1,M_2,M_3,I_p,M_p,M,LMp_v;
	local LM_v,pval;
	v_mc=zeros(n_mc,1);
	sv=round(rndu(1,4).*100); 
    sv=sv.*100;
	{D_m,D_s} =D_ms(x,res,cv);//D_hat,m,t and D_hat_sigma_t
	n=cols(D_m);
	LM_v=zeros(n_mc,1);
	for i (1,n_mc,1);
		w=rndn(n,1);
		M_1=sumc(w.*D_m')./sqrt(n);            //part 1 of (S1)
		M_2=sumc((w^2-1).*D_s')./sqrt(n);      //part 2 of (S1)
		LMp_v=zeros(n_s,1);
		for j (1,n_s,1);
			pz=p_lim[1,.]+rndu(1,3).*(p_lim[2,.]-p_lim[1,.]);
			{I_p,M_p}=I_pm_dar(x,res,cv,pz);	
			g=g_p(w, pz);				
			M_3=sumc(g)./sqrt(n);              //part 3 of (S1)
			M=M_p*(M_1|M_2|M_3);				
			LMp_v[j]=M[1]^2+M[2]^2;                //(S2)
		endfor;
		LM_v[i]=maxc(LMp_v);
	endfor;
	pval=sumc(LM_v.>s)./n_mc;
	retp(quantile(LM_v,0.90)~quantile(LM_v,0.95)~quantile(LM_v,0.99),pval);
endp;

proc (1) = crit_supMT(x,res,cv,p_lim,n_mc,n_s);
	/* This procedure computes customized critical values 
		for LM,n (that is, 'supremum') test
		inputs:
		x,res,cv: 	data, residuals and conditional variance
		p_lim:		matrix 2 x 3 of lower and upper limits for m,k, and rho
		n_mc: 		number of 'Monte Carlo' replications
		n_s: 		number of drawings of m,k and rho
	
		outputs:
		(1):	   1 x 3 vector of critical values, respectively 90%, 95% and 99%
	*/
	local LM_v,nst,sv,D_1,D_2,n,w,Mat_1,Mat_2,v1,v2,v3,v4;
	local a,b,c;
	LM_v=zeros(n_mc,1);	
	nst=round(n_s/4);
	{D_1,D_2} =D_ms(x,res,cv);//D_hat,m,t and D_hat_sigma_t
	n=cols(D_1);	
	sv=round(rndu(1,4).*100);  //different seeds for different threads
	for i (1,n_mc,1);
       // state=ceil(rndu(1,1).*1000);		
		w=rndn(n,1);
		Mat_1=sumc(w.*D_1')./sqrt(n);            //part 1 of (S1)
		Mat_2=sumc((w^2-1).*D_2')./sqrt(n);      //part 2 of (S1)
		threadBegin;
			v1=s_mc(nst,w,p_lim,x,res,cv,Mat_1,Mat_2,sv[1]);
		threadEnd;
		threadBegin;
			v2=s_mc(nst,w,p_lim,x,res,cv,Mat_1,Mat_2,sv[2]);
		threadEnd;
		threadBegin;
			v3=s_mc(nst,w,p_lim,x,res,cv,Mat_1,Mat_2,sv[3]);
		threadEnd;
		threadBegin;
			v4=s_mc(nst,w,p_lim,x,res,cv,Mat_1,Mat_2,sv[4]);
		threadEnd;
		threadJoin;
		LM_v[i]=maxc(v1|v2|v3|v4);
	endfor;	
//	{a,b,c}=hist(LM_v,11); stop;
	retp(quantile(LM_v,0.90)~quantile(LM_v,0.95)~quantile(LM_v,0.99));
endp;


 


